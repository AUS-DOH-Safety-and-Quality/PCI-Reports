---
title: "<span style='color:#0047AB; font-family:Arial;'>Western Australian Percutaneous Coronary Intervention Database Report</span>"
format:
  docx:
    toc: true
    number-sections: true
    highlight-style: github
    fig-format: svg
execute:
  echo: false
---
```{r setup, include=FALSE}
#GTSummary set to output as flextables
gtsummary::theme_gtsummary_printer(print_engine = "flextable")
#Chunk options set once for all chunks
knitr::opts_chunk$set(echo = FALSE)
```
```{r data import, include=FALSE}
#Load in the helper functions/data required
source("HelperFunctions.R")

# PowerBI Token
tk <- qiverse.azure::get_az_tk('pbi_df')
# Load data from PowerBI
pci_data <- qiverse.powerbi::download_dataflow_table(workspace_name = "PCI Data Set",
                                                dataflow_name = "Redcap PCI Registry",
                                                table_name = "PCIRegistryData",
                                                access_token = tk$credentials$access_token, verbose = TRUE)
```

```{r Data transformation, include=FALSE}
#Create period start and end, first and last date of the month
pci_data <- pci_data |>
  dplyr::mutate(dop = as.Date(dop_top),
  period_start = lubridate::floor_date(dop, unit = "month"),
  period_end = lubridate::ceiling_date(period_start, unit = "month")-1,
#Create numerator columns
  prev_cabg_num = dplyr::if_else(pcabg == "Yes", 1, 0),
  prev_pci_num = dplyr::if_else(ppci == "Yes", 1, 0),
  prev_oca_num = dplyr::if_else(arrest_pre_pci == "Yes", 1, 0),
  dis_length = dplyr::case_when(
    dod == dop ~ "SDD",
    (dod-dop) >= 2 ~ ">1 day",
    (dod-dop) >= 1 ~ "1 day",
    .default = "Unknown")) |>
#Missing data filters
  dplyr::filter(!is.na(period_end)) |>
  dplyr::filter(period_end <= Sys.Date())


pci_data <- pci_data |> 
  dplyr::mutate(door_device_time_2 = dplyr::if_else(door_device_time_2 > 300, NA_integer_, door_device_time_2),
                door_device_time_3 = dplyr::if_else(door_device_time_3 > 500, NA_integer_, door_device_time_3))
```

\newpage

## Demographics
```{r cumulative sum cases} 
# Group data to get cumulative counts for each centre over time
group_data <- pci_data |>
  dplyr::group_by(centre, period_end) |>
  dplyr::summarise(.groups = "keep", count = dplyr::n()) |>
  dplyr::arrange(centre, period_end) |>
  dplyr::group_by(centre) |>
  dplyr::mutate(cumulative_count = cumsum(count))

# Cumulative sum of PCI cases over time
ggplot2::ggplot(pci_data, ggplot2::aes(x = dop, colour = "Cumulative Total")) +
  ggplot2::stat_ecdf(ggplot2::aes(y = ggplot2::after_stat(y) * nrow(pci_data)), geom = "line", color = "black") +
  ggplot2::geom_col(data = group_data, mapping = ggplot2::aes(x = period_end, y = cumulative_count, fill = centre), position = "dodge", linewidth = 0) +
  ggplot2::labs(title = "Cumulative Total of PCI Cases Over Time",
       x = "Date of Procedure",
       y = "Cumulative Total of PCI Cases",
       fill = "Hospital",
       colour = "") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold")) +
  ggplot2::scale_y_continuous(breaks = scales::breaks_pretty(10))
```

```{r demographics_intro}
ggplot2::ggplot(pci_data, ggplot2::aes(x = reorder(centre, centre, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Procedures by Hospital",
       x = "Hospital",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r demographics_sex}
# Plotting the distribution of patients by sex
ggplot2::ggplot(pci_data, ggplot2::aes(x = sex)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Sex",
       x = "Sex",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r demographics_inds}
# Plotting the distribution of patients by Indigenous status
ggplot2::ggplot(pci_data, ggplot2::aes(x = inds)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Aboriginal or Torres Strait Islander Identity",
       x = "Aboriginal or Torres Strait Islander Identity",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r demographics_age}
# Plotting the distribution of patients by age
ggplot2::ggplot(pci_data, ggplot2::aes(x = age)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of PCI Patients by Age",
       x = "Age",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r pci_indication}
# Plotting the distribution of patients by PCI Indication
ggplot2::ggplot(dplyr::filter(pci_data, !is.na(pci_indication)), ggplot2::aes(x = stats::reorder(stringr::str_wrap(pci_indication, 10), pci_indication, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by PCI Indication",
       x = "ACS Type",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r pci_indication_list}
# Plotting the distribution of patients by PCI indication
ggplot2::ggplot(pci_data, ggplot2::aes(x = stats::reorder(stringr::str_wrap(pci_indication_list, 10), pci_indication_list, FUN = length, decreasing = T)))+
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by PCI Indication",
       x = "PCI Indication",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold")) + 
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2))
```

```{r pci_indication_list2}
# Plotting the distribution of patients by PCI indication
ggplot2::ggplot(pci_data, ggplot2::aes(y = stats::reorder(stringr::str_wrap(pci_indication_list, 30), pci_indication_list, FUN = length, decreasing = T)))+
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", hjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by PCI Indication",
       y = "PCI Indication",
       x = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r same_day_discharge}
# Plotting the distribution of patients by ACS Type
ggplot2::ggplot(pci_data, ggplot2::aes(x = dis_length)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Same Day Discharge",
       x = "Same Day Discharge",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r access}
# Plotting the distribution of patients by Access
ggplot2::ggplot(dplyr::filter(pci_data, !is.na(access)), ggplot2::aes(x = reorder(access, access, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Access Site",
       x = "Access Site",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r adjunctive_setup}
#Rename the adjunctive device columns to their lookup
adjunct_devices <- pci_data |> dplyr::select(type_adjunct___1:type_adjunct___14) |>
  dplyr::rename(
"Guide Extension" = "type_adjunct___1",
"Intravascular Ultrasound" = "type_adjunct___2",
"Optical Coherence Tomography" = "type_adjunct___3",
"Pressure Wire" = "type_adjunct___4",
"Cutting Balloon" = "type_adjunct___5",
"Scoring Balloon" = "type_adjunct___6",
"OPN Balloon" = "type_adjunct___7",
"Thrombus Aspiration" = "type_adjunct___8",
"Distal Protection" = "type_adjunct___9",
"Rotational Atherectomy" = "type_adjunct___10",
"Orbital Atherectomy" = "type_adjunct___11",
"Intravascular Lithotripsy (Shockwave)" = "type_adjunct___12",
"Microcatheter" = "type_adjunct___13",
"Other" = "type_adjunct___14"
  ) |>
    #Over all the adjunct columns, convert "Checked" to 1 and everything else to 0
  dplyr::mutate(dplyr::across(dplyr::everything(), \(x) ifelse(x == "Checked", 1, 0))) |>
    #Summarise each adjunctive device to get the total count of patients using each device
  dplyr::summarise(dplyr::across(dplyr::everything(), \(x) sum(x, na.rm = TRUE))) |>
    #Transpose the data for easier plotting
  t() |>
  as.data.frame()

#Transpose takes the column names and makes them row names so we need to pull them out into a column
adjunct_devices$adjunct <- rownames(adjunct_devices)

adjunct_devices_10 <- adjunct_devices |> 
  dplyr::slice_max(n = 10, order_by = V1)

```

```{r adjunctive_plot}
# Plotting the distribution of patients by Adjunctive device
ggplot2::ggplot(adjunct_devices, ggplot2::aes(x = stats::reorder(stringr::str_wrap(adjunct, 10), -V1), y = V1)) +
  ggplot2::geom_bar(stat = "identity", fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = V1), stat = "identity", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of Adjunctive Devices used in PCI Procedures",
       x = "Adjunctve Device",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold")) + 
  ggplot2::scale_x_discrete(guide = ggplot2::guide_axis(n.dodge=2))

```

```{r adjunctive_plot2}
# Plotting the distribution of patients by Adjunctive device
ggplot2::ggplot(adjunct_devices, ggplot2::aes(y = stats::reorder(stringr::str_wrap(adjunct, 20), V1), x = V1)) +
  ggplot2::geom_bar(stat = "identity", fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = V1), stat = "identity", hjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of Adjunctive Devices used in PCI Procedures",
       y = "Adjunctve Device",
       x = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r number_lesions}
pci_data <- pci_data |> 
  dplyr::mutate(across(c("lesion_type_1", "lesion_type_lesion2", "lesion_type_lesion3",
    "lesion_type_lesion4", "lesion_type_lesion5"), ~ ifelse(is.na(.), 0, 1)))
pci_data$lesion_total <- rowSums(pci_data[c("lesion_type_1", "lesion_type_lesion2",
  "lesion_type_lesion3", "lesion_type_lesion4", "lesion_type_lesion5")])

# Plotting the distribution of patients by number of lesions
ggplot2::ggplot(dplyr::filter(pci_data, !is.na(lesion_total)), ggplot2::aes(x = reorder(lesion_total, 
  x = lesion_total, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Number of Lesions",
       x = "Lesions",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"),
    axis.title.x = ggplot2::element_text(size = 8),
    axis.title.y = ggplot2::element_text(size = 8))

```

```{r pci_location}
# Plotting the distribution of patients by first PCI lesion location
ggplot2::ggplot(pci_data, ggplot2::aes(y = stats::reorder(pci_location_lesion1, pci_location_lesion1, FUN = length, decreasing = F)))+
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", hjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of First PCI Lesions by Location",
       y = "PCI Lesion Location",
       x = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r technique}
# Plotting the distribution of patients by PCI Technique
ggplot2::ggplot(dplyr::filter(pci_data, !is.na(final_technique_lesion1)), 
  ggplot2::aes(x = reorder(stringr::str_wrap(final_technique_lesion1, 10), final_technique_lesion1, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by PCI Technique",
       x = "Technique",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r stent_count}
pci_data <- pci_data |> 
  dplyr::mutate(number_stents_lesion4 = as.integer(number_stents_lesion4),
                number_stents_lesion5 = as.integer(number_stents_lesion5))

pci_data$stents_total <- rowSums(pci_data[c("number_stents_lesion1", "number_stents_lesion2",
  "number_stents_lesion3", "number_stents_lesion4", "number_stents_lesion5")], na.rm = TRUE)

# Plotting the distribution of patients by total stents used
ggplot2::ggplot(dplyr::filter(pci_data, !is.na(stents_total)), ggplot2::aes(x = stents_total)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Patients by Total Stents Used",
       x = "Total Stents Used",
       y = "Count") +
  ggplot2::theme_minimal() + 
  ggplot2::scale_x_continuous(breaks = 0:max(pci_data$stents_total)) +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

## Proportion of Patients with a previous PCI

### Funnel Plot
```{r fpl_setup_ppci}
#| out-width: 80%
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_pci_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% PCI Patients with a previous PCI"),
    ylimit_label_size = 14, ylimit_sig_figs = 1, ylimit_u = 35),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE))
fpl_data
```

``` {r fpl_patterns_ppci}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_ppci} 
#| out-width: "80%"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_pci_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% PCI Patients with a previous PCI", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " ")
)
spc_data
```

``` {r spc_patterns_ppci}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."

```

`r pattern_text`

\newpage

## Proportion of Patients with a previous CABG

### Funnel Plot
```{r fpl_setup_pcabg}
#| out-width: "80%"
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_cabg_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% PCI Patients with a previous CABG"), 
    ylimit_label_size = 14, ylimit_sig_figs = 1, ylimit_u = 7),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

``` {r fpl_patterns_pcabg}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_pcabg} 
#| out-width: "80%"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_cabg_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% PCI Patients with a previous CABG", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " ")
)
spc_data
```

``` {r spc_patterns_pcabg}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."
```

`r pattern_text`

\newpage

## Proportion of Patients with a previous OHCA

### Funnel Plot
```{r fpl_setup_pOHCA}
#| out-width: "80%"
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_oca_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% PCI Patients with a previous OHCA"), 
    ylimit_label_size = 14, ylimit_sig_figs = 1, ylimit_u = 7),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

``` {r fpl_patterns_pOHCA}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_pOHCA} 
#| out-width: "80%"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_oca_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% PCI Patients with a previous OHCA", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " ")
)
spc_data
```

``` {r spc_patterns_pOHCA}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."
```

`r pattern_text`

\newpage

## Co-morbidities Breakdown

```{r co-morbidities}
comorbs <- c("db", "dbm", "pvd2", "stroke", "dyslipidaemia", "smk", "heart_failure", "htn", "lung_disease","dial")

 gtsummary::tbl_summary(pci_data,
    include = dplyr::all_of(comorbs),
    label = list(
      db ~ "Diabetes",
      dbm ~ "Diabetes Type",
      pvd2 ~ "Peripheral Vascular Disease",
      stroke ~ "Stroke",
      dyslipidaemia ~ "Dyslipidaemia",
      smk ~ "Smoking Status",
      heart_failure ~ "Heart Failure",
      htn ~ "Hypertension",
      lung_disease ~ "Lung Disease",
      dial ~ "Renal Dialysis"
    ),
    statistic = list(
      dplyr::all_of(comorbs) ~ "N: {n} | D: {N} | %: {p}"
    ),
    missing = "no"
  ) |> gtsummary::as_gt()

```

## STEMI Device Timing KPI Summary Table
```{r device_times_setup}
#Convert to numeric
pci_data$pain_device_time_4 <- as.numeric(pci_data$pain_device_time_4)

#Create lookup tables for each group of times
device_label = list(
      "Door to Device:" = list(
        door_device_kpi ~ "Ambulance (KPI <90)",
        door_device_time_2 ~ "PCI Centre ED (KPI <90)",
        door_device_time_3 ~ "Non PCI Centre ED (KPI <120)",
        door_device_time_5 ~ "Rescue PCI"),
      "FMC to Device:" = list(
        fmc_device_time ~ "Ambulance",
        fmc_device_time_2 ~ "PCI Centre ED",
        fmc_device_time_3 ~ "Non PCI Centre ED"),
      "Pain to Device:" = list(
        pain_device_time ~ "Ambulance",
        pain_device_time_2 ~ "PCI Centre ED",
        pain_device_time_3 ~ "Non PCI Centre ED",
        pain_device_time_4 ~ "PCI Centre Ward",
        pain_device_time_5 ~ "Rescue PCI")
      )
#Same grouping as above in a different format
device_cols <- list(
      "Door to Device:" = c(
        "door_device_kpi",
        "door_device_time_2",
        "door_device_time_3",
        "door_device_time_5"),
      "FMC to Device:" = c(
        "fmc_device_time",
        "fmc_device_time_2",
        "fmc_device_time_3"),
      "Pain to Device:" = c(
        "pain_device_time",
        "pain_device_time_2",
        "pain_device_time_3",
        "pain_device_time_4",
        "pain_device_time_5")
      )
#Table for door to device time
door_to_device <- gtsummary::tbl_summary(pci_data,
#Over all the columns for Door to device
    include = dplyr::all_of(device_cols[["Door to Device:"]]),
    label = device_label[["Door to Device:"]],
    statistic = list(
      #Calculate the statistics
      dplyr::all_of(device_cols[["Door to Device:"]]) ~ "Median: {median} | Mean: {mean} | SD: {sd} | Count: {N_nonmiss}"
    ),
    missing = "no"
  )

FMC_to_device <- gtsummary::tbl_summary(pci_data,
    include = dplyr::all_of(device_cols[["FMC to Device:"]]),
    label = device_label[["FMC to Device:"]],
    statistic = list(
      dplyr::all_of(device_cols[["FMC to Device:"]]) ~ "Median: {median} | Mean: {mean} | SD: {sd} | Count: {N_nonmiss}"
    ),
    missing = "no"
  )

pain_to_device <- gtsummary::tbl_summary(pci_data,
    include = dplyr::all_of(device_cols[["Pain to Device:"]]),
    label = device_label[["Pain to Device:"]],
    statistic = list(
      dplyr::all_of(device_cols[["Pain to Device:"]]) ~ "Median: {median} | Mean: {mean} | SD: {sd} | Count: {N_nonmiss}"
    ),
    missing = "no"
  )

#stack the tables together
combined_table <- gtsummary::tbl_stack(list(door_to_device, FMC_to_device, pain_to_device), 
  group_header = c("Door to Device Time", "First Medical Contact to Device Time", "Pain Onset to Device Time")) |>
    gtsummary::modify_header(label = "**STEMI Device Timing Indicators**")
```

```{r devices_times}
#| out-width: "80%"
combined_table |> gtsummary::as_gt()
```

\newpage

### Ambulance Prenotified Arrival at PCI Centre to Device Time
```{r spc_setup_timings_pain_device} 
#| out-width: "80%"
#Ambulance Arrival to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(door_device_kpi)),
  keys = period_end,
  numerators = door_device_kpi,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean Time (minutes)", 
    ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  line_settings = list(plot_label_show_main = TRUE, plot_label_show_target = TRUE, show_alt_target = TRUE,
    alt_target = 90, colour_alt_target = "#00667B", plot_label_show_alt_target = TRUE),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE, show_assurance_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " "))
spc_data
```

### PCI Centre ED Arrival to Device Time
```{r spc_setup_timing_FMC_device} 
#| out-width: "80%"
#PCI Centre ED arrival to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(door_device_time_2)),
  keys = period_end,
  numerators = door_device_time_2,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean Time (minutes)", 
    ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  line_settings = list(plot_label_show_target = TRUE, show_alt_target = TRUE,
    alt_target = 90, colour_alt_target = "#00667B", plot_label_show_alt_target = TRUE),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE, show_assurance_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " ")
)
spc_data
```

### Non-PCI Centre Arrival to Device Time
```{r spc_setup_timing_Door_device} 
#| out-width: "80%"
#Non PCI Centre Door to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(door_device_time_3)),
  keys = period_end,
  numerators = door_device_time_3,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean Time (minutes)",
    ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  line_settings = list(plot_label_show_target = TRUE, show_alt_target = TRUE,
    alt_target = 120, colour_alt_target = "#00667B", plot_label_show_alt_target = TRUE),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE, show_assurance_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY", date_format_delim = " ")
)
spc_data
```


## Editing the Report
This report is created using Quarto and R to produce a Microsoft Word output, if you want to edit the report styling to fit your reporting requirements, right click any graph and select **Convert to Shape**, this will allow you to edit graphs as needed.