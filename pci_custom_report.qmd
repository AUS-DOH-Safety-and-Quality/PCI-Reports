---
title: "<span style='color:#0047AB; font-family:Arial;'>Customised Percutaneous Coronary Interventions Report</span>"
format:
  docx:
    toc: true
    number-sections: true
    highlight-style: github
    fig-format: svg
execute:
  echo: false
---

```{r data import, include=FALSE}
if (!file.exists("./pci_data.csv")) {
  stop("NCR dataset not found! Please check that you have a single CSV file named 'pci_data.csv' in the current directory!",
       call. = FALSE)
}
#Load in the helper functions/data required
source("HelperFunctions.R")

# PowerBI Token
tk <- qiverse.azure::get_az_tk('pbi_df')
# Load data from PowerBI
pci_data <- qiverse.powerbi::download_dataflow_table(workspace_name = "PCI Data Set",
                                                dataflow_name = "Redcap PCI Registry",
                                                table_name = "PCIRegistryData",
                                                access_token = tk$credentials$access_token, verbose = TRUE)
```

```{r Data transformation, include=FALSE}
#Create period start and end, first and last date of the month
pci_data <- pci_data |>
  dplyr::mutate(dop = as.Date(dop_top),
  period_start = lubridate::floor_date(dop, unit = "month"),
  period_end = lubridate::ceiling_date(period_start, unit = "month")-1,
#Create numerator columns
  prev_cabg_num = dplyr::if_else(pcabg == "Yes", 1, 0),
  prev_pci_num = dplyr::if_else(ppci == "Yes", 1, 0),
  prev_oca_num = dplyr::if_else(arrest_pre_pci == "Yes", 1, 0),
  dis_length = dplyr::case_when(
    dod == dop ~ "SDD",
    (dod-dop) >= 2 ~ ">1 day",
    (dod-dop) >= 1 ~ "1 day",
    .default = "Unknown")) |>
#Missing data filters
  dplyr::filter(!is.na(period_end)) |>
  dplyr::filter(period_end <= Sys.Date())

```

\newpage

## Proportion of Patients with a previous PCI

### Funnel Plot
```{r fpl_setup_ppci, echo=FALSE}
#| fig.cap="Funnel plot for the proportion of patients with a previous PCI"
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_pci_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% Patients with a previous PCI"), ylimit_label_size = 14, ylimit_sig_figs = 1),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

``` {r fpl_patterns_ppci, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_ppci, echo=FALSE} 
#| fig.cap="SPC chart for the proportion of patients with a previous PCI"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_pci_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with a previous PCI", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```

``` {r spc_patterns_ppci, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."

```

`r pattern_text`

\newpage

## Proportion of Patients with a previous CABG

### Funnel Plot
```{r fpl_setup_pcabg, echo=FALSE}
#| fig.cap="Funnel plot for the proportion of patients with a previous CABG"
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_cabg_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% Patients with a previous CABG"), ylimit_label_size = 14, ylimit_sig_figs = 1),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

``` {r fpl_patterns_pcabg, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_pcabg, echo=FALSE} 
#| fig.cap="SPC chart for the proportion of patients with a previous CABG"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_cabg_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with a previous CABG", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```

``` {r spc_patterns_pcabg, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."
```

`r pattern_text`

\newpage

## Proportion of Patients with a previous OHCA

### Funnel Plot
```{r fpl_setup_pOHCA, echo=FALSE}
#| fig.cap="Funnel plot for the proportion of patients with a previous OHCA"
fpl_data <- controlcharts::funnel(
  data = pci_data,
  keys = centre,
  numerators = prev_oca_num,
  denominators = rep(1, nrow(pci_data)),
  y_axis_settings = list(ylimit_label = paste0("% Patients with a previous OHCA"), ylimit_label_size = 14, ylimit_sig_figs = 1),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

``` {r fpl_patterns_pOHCA, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- fpl_data$limits |> dplyr::filter(three_sigma == "deterioration")

pattern_text <- "Using the Making Data Count approach, no patterns were identified in the Funnel Plot."
#Only include text if a pattern was identified
pattern_text <- if(length(astpoint$group) != 0) {
    pattern_text <- paste0("An astronomical point was identified for ", stringr::str_flatten(astpoint$group, collapse = ", "), ".")}

```

`r pattern_text`

### SPC Chart
```{r spc_setup_pOHCA, echo=FALSE} 
#| fig.cap="SPC chart for the proportion of patients with a previous OHCA"
spc_data <- controlcharts::spc(
  data = pci_data,
  keys = period_end,
  numerators = prev_oca_num,
  denominators = rep(1, nrow(pci_data)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with a previous OHCA", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```

``` {r spc_patterns_pOHCA, echo=FALSE}
#Filter the spc limits data to get the latest patterns identified
astpoint <- spc_data$limits |> dplyr::filter(astpoint != "none")
#Filter to the last point in the ordered dates
astpoint <- astpoint$date[length(astpoint$date)]
trend <- spc_data$limits |> dplyr::filter(trend != "none")
trend <- trend$date[length(trend$date)]
shift <- spc_data$limits |> dplyr::filter(shift != "none")
shift <- shift$date[length(shift$date)]
two_in_three <- spc_data$limits |> dplyr::filter(two_in_three != "none")
two_in_three <- two_in_three$date[length(two_in_three$date)]

pattern_text <- "Using the Making Data Count approach, the following most recent patterns have been identified in the SPC chart: "
#Only include text if a pattern was identified
if(length(astpoint) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("An astronomical point was identified on ", astpoint, ". ")))}
if(length(trend) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A trend was identified on ", trend, ". ")))}
if(length(shift) == 1) {
  pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A shift was identified on ", shift, ". ")))}
if(length(two_in_three) == 1) {
   pattern_text <- stringr::str_flatten(c(pattern_text, paste0("A two in three was identified on ", two_in_three, ". ")))}

if(stringr::str_length(pattern_text) != 112) patttern_text <- "Using the Making Data Count approach, no patterns were identified in the SPC chart."


```

`r pattern_text`

\newpage

## Demographics
```{r demographics_sex, echo=FALSE}
# Plotting the distribution of patients by sex
ggplot2::ggplot(pci_data, ggplot2::aes(x = sex)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of Patients by Sex",
       x = "Sex",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r demographics_inds, echo=FALSE}
# Plotting the distribution of patients by Indigenous status
ggplot2::ggplot(pci_data, ggplot2::aes(x = inds)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of Patients by Aboriginal or Torres Strait Islander Identity",
       x = "Aboriginal or Torres Strait Islander Identity",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r demographics_age, echo=FALSE}
# Plotting the distribution of patients by age
ggplot2::ggplot(pci_data, ggplot2::aes(x = age)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of Patients by Age",
       x = "Age",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
```

```{r procedures, echo=FALSE}
# Plotting the distribution of patients by ACS Type
ggplot2::ggplot(pci_data, ggplot2::aes(x = stringr::str_wrap(type_acs, 10))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of Patients by ACS Type",
       x = "ACS Type",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

```{r same_day_discharge, echo=FALSE}
# Plotting the distribution of patients by ACS Type
ggplot2::ggplot(pci_data, ggplot2::aes(x = dis_length)) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::labs(title = "Distribution of Patients by Same Day Discharge",
       x = "Same Day Discharge",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))

```

## Co-morbidities Breakdown

```{r co-morbidities, echo=FALSE}
comorbs <- c("db", "dbm", "pvd2", "stroke", "dyslipidaemia", "smk", "heart_failure", "htn", "lung_disease","dial")

 gtsummary::tbl_summary(pci_data,
    include = dplyr::all_of(comorbs),
    label = list(
      db ~ "Diabetes",
      dbm ~ "Diabetes Type",
      pvd2 ~ "Peripheral Vascular Disease",
      stroke ~ "Stroke",
      dyslipidaemia ~ "Dyslipidaemia",
      smk ~ "Smoking Status",
      heart_failure ~ "Heart Failure",
      htn ~ "Hypertension",
      lung_disease ~ "Lung Disease",
      dial ~ "Renal Dialysis"
    ),
    statistic = list(
      dplyr::all_of(comorbs) ~ "N: {n} | D: {N} | %: {p}"
    ),
    missing = "no"
  ) |> gtsummary::as_flex_table()


```

## Onset of Pain to Device Time
```{r spc_setup_timings_pain_device, echo=FALSE} 

#Pain to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(pain_device_time)),
  keys = period_end,
  numerators = pain_device_time,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean time from Onset of Chest Pain to Device", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```

## First Medical Contact to Device Time
```{r spc_setup_timing_FMC_device, echo=FALSE} 

#First Medical Contact to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(fmc_device_time)),
  keys = period_end,
  numerators = fmc_device_time,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean time from First Medical Contact to Device", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```

## Door to Device Time
```{r spc_setup_timing_Door_device, echo=FALSE} 

#Door to device time
spc_data <- controlcharts::spc(
  data = dplyr::filter(pci_data, !is.na(fmc_device_time)),
  keys = period_end,
  numerators = door_device_kpi,
  spc_settings = list(chart_type = "i"),
  aggregations = list(numerators = "mean"),
  y_axis_settings = list(ylimit_label = "Mean time from Door to Device", ylimit_label_size = 14, ylimit_tick_rotation = 0, ylimit_sig_figs = 0),
  outlier_settings = list(improvement_direction = "decrease", astronomical = TRUE, shift = TRUE, trend = TRUE, two_in_three = TRUE),
  nhs_icon_settings = list(show_variation_icons = TRUE),
  date_settings = list(date_format_day = "(blank)", date_format_month = "Mon", date_format_year = "YY")
)
spc_data
```


```{r device_times_setup, echo=FALSE}

devices <- c("door_device_kpi", "door_device_time_2", "door_device_time_3", "door_device_time_5", "fmc_device_time", "fmc_device_time_2", "fmc_device_time_3", "pain_device_time", "pain_device_time_2", "pain_device_time_3", "pain_device_time_4", "pain_device_time_5")

table(pci_data$pain_device_time_4)
pci_data$pain_device_time_4 <- as.numeric(pci_data$pain_device_time_4)

gtsummary::tbl_summary(pci_data,
    include = dplyr::all_of(devices),
    label = list(
      door_device_kpi ~ "Door to Device: Ambulance",
      door_device_time_2 ~ "Door to Device: PCI Centre ED",
      door_device_time_3 ~ "Door to Device: Non PCI Centre ED",
      door_device_time_5 ~ "Door to Device: Rescue PCI",
      fmc_device_time ~ "FMC to Device: Ambulance",
      fmc_device_time_2 ~ "FMC to Device: PCI Centre ED",
      fmc_device_time_3 ~ "FMC to Device: Non PCI Centre ED",
      pain_device_time ~ "Pain to Device: Ambulance",
      pain_device_time_2 ~ "Pain to Device: PCI Centre ED",
      pain_device_time_3 ~ "Pain to Device: Non PCI Centre ED",
      pain_device_time_4 ~ "Pain to Device: PCI Centre Ward",
      pain_device_time_5 ~ "Pain to Device: Rescue PCI"
    ),
    statistic = list(
      dplyr::all_of(devices) ~ "Median: {median} | Mean: {mean} | SD: {sd} | Min: {min} | Max: {max}"
    ),
    missing = "no"
  ) |> gtsummary::as_flex_table()



```
