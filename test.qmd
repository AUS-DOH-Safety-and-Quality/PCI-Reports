---
title: "<span style='color:#0047AB; font-family:Arial;'>Customised Percutaneous Coronary Interventions Report</span>"
format:
  html:
    toc: true
    number-sections: true
    highlight-style: github
    fig-format: svg
execute:
  echo: false
---

# Demographics

This section displays the following column charts:

- **Height Group Bar Plot:** Shows the proportion of male and female patients in each height group (in cm, grouped by intervals of 10).
- **Weight Group Bar Plot:** Shows the proportion of male and female patients in each weight group (in kg, grouped by intervals of 10).
- **Age Group Bar Plot:** Shows the proportion of male and female patients in each age group (<40, 40-49, 50-59, 60-69, 70-79, >=80).
- **Aboriginal Status Bar Plot:** Shows the proportion of male and female patients by Aboriginal status (Aboriginal, Non Aboriginal, Unknown) based on the `Inds` column.

All proportions are calculated as the fraction of each sex within the respective group. Missing and null values are excluded from all plots.

```{r import, include=FALSE}
library(ggplot2)
library(dplyr)
library(controlcharts)

# Load the data
data <- read.csv('pci_data.csv')
```

```{r height-transform, include=FALSE}
# Handle missing/null values for htm and create height groups by sex
htm_clean <- data %>% filter(!is.na(htm) & htm != "" & sex %in% c(1,2))
htm_clean <- htm_clean %>% mutate(
  htm_group = cut(as.numeric(htm), breaks=seq(100, 220, by=10), right=FALSE, include.lowest=TRUE),
  sex_cat = case_when(sex == 1 ~ "Male", sex == 2 ~ "Female")
)
htm_counts <- htm_clean %>% count(htm_group, sex_cat) %>% arrange(htm_group, sex_cat)
```

```{r height-plot}
htm_counts <- htm_counts %>% group_by(sex_cat) %>% mutate(prop = n / sum(n)) %>% ungroup()
ggplot(htm_counts, aes(x=htm_group, y=prop, fill=sex_cat)) +
  geom_bar(stat='identity', position='dodge') +
  scale_fill_manual(values=c("Male"="#0047AB", "Female"="#d62728")) +
  theme_minimal() +
  labs(title='Proportion of Each Sex by Height Group', x='Height Group (cm)', y='Proportion of Sex', fill='Sex') +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r weight-transform, include=FALSE}
# Handle missing/null values for wkg and create weight groups by sex
wkg_clean <- data %>% filter(!is.na(wkg) & wkg != "" & sex %in% c(1,2))
wkg_clean <- wkg_clean %>% mutate(
  wkg_group = cut(as.numeric(wkg), breaks=seq(30, 200, by=10), right=FALSE, include.lowest=TRUE),
  sex_cat = case_when(sex == 1 ~ "Male", sex == 2 ~ "Female")
)
wkg_counts <- wkg_clean %>% count(wkg_group, sex_cat) %>% arrange(wkg_group, sex_cat)
```

```{r weight-plot}
wkg_counts <- wkg_counts %>% group_by(sex_cat) %>% mutate(prop = n / sum(n)) %>% ungroup()
ggplot(wkg_counts, aes(x=wkg_group, y=prop, fill=sex_cat)) +
  geom_bar(stat='identity', position='dodge') +
  scale_fill_manual(values=c("Male"="#0047AB", "Female"="#d62728")) +
  theme_minimal() +
  labs(title='Proportion of Each Sex by Weight Group', x='Weight Group (kg)', y='Proportion of Sex', fill='Sex') +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r age-transform, include=FALSE}
# Age groups: <40, 40-49, 50-59, 60-69, 70-79, >=80
age_clean <- data %>% filter(!is.na(age) & age != "" & sex %in% c(1,2))
age_clean <- age_clean %>% mutate(
  age_group = cut(as.numeric(age), breaks=c(-Inf, 39, 49, 59, 69, 79, Inf), labels=c("<40", "40-49", "50-59", "60-69", "70-79", ">=80"), right=TRUE),
  sex_cat = case_when(sex == 1 ~ "Male", sex == 2 ~ "Female")
)
age_counts <- age_clean %>% count(age_group, sex_cat) %>% arrange(age_group, sex_cat)
```

```{r inds-transform, include=FALSE}
# Inds: 1,2,3 = Aboriginal; 0 = Non Aboriginal; -1 = Unknown
inds_clean <- data %>% filter(!is.na(inds) & inds != "" & sex %in% c(1,2))
inds_clean <- inds_clean %>% mutate(
  aboriginal_status = case_when(
    inds %in% c(1,2,3) ~ "Aboriginal",
    inds == 0 ~ "Non Aboriginal",
    inds == -1 ~ "Unknown"
  ),
  sex_cat = case_when(sex == 1 ~ "Male", sex == 2 ~ "Female")
)
inds_counts <- inds_clean %>% count(aboriginal_status, sex_cat) %>% arrange(aboriginal_status, sex_cat)
```

```{r age-plot}
age_counts <- age_counts %>% group_by(sex_cat) %>% mutate(prop = n / sum(n)) %>% ungroup()
ggplot(age_counts, aes(x=age_group, y=prop, fill=sex_cat)) +
  geom_bar(stat='identity', position='dodge') +
  scale_fill_manual(values=c("Male"="#0047AB", "Female"="#d62728")) +
  theme_minimal() +
  labs(title='Proportion of Each Sex by Age Group', x='Age Group', y='Proportion of Sex', fill='Sex') +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r inds-plot}
inds_counts <- inds_counts %>% group_by(sex_cat) %>% mutate(prop = n / sum(n)) %>% ungroup()
ggplot(inds_counts, aes(x=aboriginal_status, y=prop, fill=sex_cat)) +
  geom_bar(stat='identity', position='dodge') +
  scale_fill_manual(values=c("Male"="#0047AB", "Female"="#d62728")) +
  theme_minimal() +
  labs(title='Proportion of Each Sex by Aboriginal Status', x='Aboriginal Status', y='Proportion of Sex', fill='Sex') +
  scale_y_continuous(labels=scales::percent) +
  theme(axis.text.x = element_text(angle = 0, hjust = 0.5))
```

# Previous Procedures

This section displays the following SPC charts:

- **PCI SPC Chart:** Shows the proportion of patients receiving PCI over time.
- **CABG SPC Chart:** Shows the proportion of patients receiving CABG over time.
- **Previous PCI SPC Chart:** Shows the proportion of patients with a history of PCI over time.

```{r previous-procedures-transform, include=FALSE}
# Numerators and denominators for PCI, CABG (now ihtvcab), Previous PCI
pci_clean <- data %>% mutate(PCI_num = ifelse(pci == 1, 1, 0))
cabg_clean <- data %>% mutate(CABG_num = ifelse(ihtvcab == 1, 1, 0))
ppci_clean <- data %>% mutate(PPCI_num = ifelse(ppci == 1, 1, 0))
pci_denominator <- nrow(data)
```

```{r previous-procedures-PCI}
PCI_spc <- controlcharts::spc(
  data = pci_clean,
  keys = NULL,
  numerators = pci_clean$PCI_num,
  denominators = rep(1, nrow(pci_clean)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with PCI", ylimit_label_size = 14),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  nhs_icon_settings = list(show_variation_icons = TRUE)
)
if (nrow(pci_clean) > 0) PCI_spc else print("No PCI data available.")
PCI_spc
```

```{r previous-procedures-CABG}
CABG_spc <- controlcharts::spc(
  data = cabg_clean,
  keys = NULL,
  numerators = cabg_clean$CABG_num,
  denominators = rep(1, nrow(cabg_clean)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with CABG", ylimit_label_size = 14),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  nhs_icon_settings = list(show_variation_icons = TRUE)
)
if (nrow(cabg_clean) > 0) CABG_spc else print("No CABG data available.")
```

```{r previous-procedures-PPCI}
PPCI_spc <- controlcharts::spc(
  data = ppci_clean,
  keys = NULL,
  numerators = ppci_clean$PPCI_num,
  denominators = rep(1, nrow(ppci_clean)),
  spc_settings = list(chart_type = "p"),
  y_axis_settings = list(ylimit_label = "% Patients with Previous PCI", ylimit_label_size = 14),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  nhs_icon_settings = list(show_variation_icons = TRUE)
)
if (nrow(ppci_clean) > 0) PPCI_spc else print("No Previous PCI data available.")
```


