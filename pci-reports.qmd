---
title: "`r {
  capitalise <- function(x) {
    paste0(toupper(substr(x, 1, 1)), tolower(substr(x, 2, nchar(x))))
  }
  title <- paste0('PCI Report - ', capitalise(Sys.getenv('QUARTO_PROFILE')))
  if (!is.na(params$target_id)) {
    title <- paste(title, params$target_id)
  }
  title
}`"
format:
  docx:
    toc: true
    number-sections: true
    highlight-style: github
    fig-format: svg
  html:
    toc: true
    toc-location: left
    embed-resources: true
params:
  target_id: !expr NA
knitr:
  opts_chunk:
    dev: "svglite"
execute:
  echo: false
---
```{r, include=FALSE}
gtsummary::theme_gtsummary_printer(print_engine = "flextable")
```

```{r Data download, include=FALSE}
if (!file.exists("./pci_data.csv")) {
  stop("NCR dataset not found! Please check that you have a single CSV file named 'pci_data.csv' in the current directory!",
       call. = FALSE)
}

#Load in the helper functions/data required
source("HelperFunctions.R")

#Read in data from PowerBI
pci_data <- readr::read_csv("./pci_data.csv", col_types = colTypes)
```

```{r Report context setup, include=FALSE}
# Report context setup - controls statewide/hospital/clinician mode
report_context <- Sys.getenv("QUARTO_PROFILE")
target_id <- params$target_id

# Validate parameters
if (report_context %in% c("hospital", "clinician") && is.na(target_id)) {
  stop("target_id must be provided for hospital or clinician context", call. = FALSE)
}
```

```{r Data transformation, include=FALSE}
pci_data <- prepare_pci_data(pci_data)
```

\newpage

This report summarises the National Cardiac Registry Indicators for Percutaneous Coronary Intervention.

::: {.callout-tip collapse="true"}
# Patterns in SPC Charts and Funnel Plots

The following patterns are highlighted in this report.

## Astronomical Point

An identified point that exceeds 3 sigma limits from the mean.

```{r showing astro sample, echo = FALSE}
spc_example_plotly(spc_example_data_astro)
```

## Trend

Five or more consecutively increasing or decreasing points.

```{r showing trend sample, echo = FALSE}
spc_example_plotly(spc_example_data_trend)
```

## Two in Three

Two out of Three consecutive points exceeding 2 sigma limits from the mean.

```{r showing two in three sample, echo = FALSE}
spc_example_plotly(spc_example_data_twothree)
```

## Shift

Seven or more consecutive points above or below the mean.

```{r showing shift sample, echo = FALSE}
spc_example_plotly(spc_example_data_shift)
```

## Funnel Plot Outlier

An identified point that exceeds 3 sigma limits from the mean.

```{r showing Funnel Outlier sample, echo = FALSE}
funnel_example_plotly(fpl_example_data)
```

:::

# Patient Demographics

## Patient Characteristics by Clinical Presentation

```{r demographics by acs, message=FALSE, warning=FALSE}
# Adding and formatting columns for use in demographics tables
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(age) & !is.na(inds_cat) & !is.na(acs_cat))

# Statewide: columns are clinical presentation
# Hospital/Clinician: within each clinical presentation, compare Target vs Other
if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(age, sex_cat, inds_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca),
      by = "acs_cat",
      label = list(
        age ~ "Age",
        sex_cat ~ "Sex",
        inds_cat ~ "Indigenous Status",
        db ~ "Diabetic",
        pvd ~ "Peripheral Vascular Disease",
        bmi ~ "BMI",
        severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
        ppci ~ "Previous PCI",
        pcabg ~ "Previous CABG",
        shock ~ "Cardiogenic Shock",
        oca ~ "Out of Hospital Cardiac Arrest",
        los_cat ~ "Length of Stay"
      ),
      statistic = list(
        c(age, bmi) ~ "{mean} ({sd})",
        c(sex_cat, inds_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat) ~ "{n} ({p}%)"
      ),
      digits = list(
        c(age, bmi) ~ 1
      ),
      missing = "no"
    )
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(age, sex_cat, inds_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca),
        by = "comparison_group",
        label = list(
          age ~ "Age",
          sex_cat ~ "Sex",
          inds_cat ~ "Indigenous Status",
          db ~ "Diabetic",
          pvd ~ "Peripheral Vascular Disease",
          bmi ~ "BMI",
          severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
          ppci ~ "Previous PCI",
          pcabg ~ "Previous CABG",
          shock ~ "Cardiogenic Shock",
          oca ~ "Out of Hospital Cardiac Arrest",
          los_cat ~ "Length of Stay"
        ),
        statistic = list(
          c(age, bmi) ~ "{mean} ({sd})",
          c(sex_cat, inds_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat) ~ "{n} ({p}%)"
        ),
        digits = list(
          c(age, bmi) ~ 1
        ),
        missing = "no"
      )
    )
}
```

## All patients by Age and Sex

```{r Split Demographics, fig.width=8, fig.height=5}
# ggplot will be used for all plotting (aside from control charts)
library(ggplot2)
# The ggstats package provides several helpful utilities for plotting summarising data
library(ggstats)

age_plt <- pci_data |>
  ## 1 NA age record appears in the cohort, remove these values.
  dplyr::filter(!is.na(age_cat)) |>
  ggplot(aes(x = age_cat, fill = sex_cat, by = 1, y = after_stat(prop))) +
    geom_prop_bar() +
    geom_prop_text() +
    theme_minimal() +
    scale_fill_manual(values = c("Female" = "#d62728", "Male" = "#0047AB", "Other" = "grey")) +
    scale_y_continuous(labels = scales::percent) +
    # Label axis and Title
    labs(
      title = "Proportion of all Patients by Age & Sex",
      x = "Age Category",
      y = "Proportion (%)",
      fill = "Sex"
    ) +
    theme(
      legend.position = "bottom"
    )

print_ggplot(age_plt)
```

## All Aboriginal patients by Age and Sex

```{r Split Aboriginal Demographics, fig.width=8, fig.height=5}
atsi_plt <- pci_data |>
  ## 1 NA age record appears in the cohort, remove these values.
  dplyr::filter(!is.na(age_cat) & inds %in% c(1, 2, 3)) |>
  ggplot(aes(x = age_cat, fill = sex_cat, by = 1, y = after_stat(prop))) +
    geom_prop_bar() +
    geom_prop_text() +
    theme_minimal() +
    scale_fill_manual(values = c("Female" = "#d62728", "Male" = "#0047AB", "Other" = "grey")) +
    scale_y_continuous(labels = scales::percent) +
    # Label axis and Title
    labs(
      title = "Proportion of ATSI Patients by Age and Sex",
      x = "Age Category",
      y = "Proportion of ATSI Patients (%)",
      fill = "Sex"
    ) +
    theme(
      legend.position = "bottom"
    )

print_ggplot(atsi_plt)
```

::: {.content-visible when-profile="statewide"}

## Patient Characteristics by Hospital Volume

```{r demographics by hospital volume, message=FALSE, warning=FALSE}
#| eval: !expr report_context == "statewide"
filter_for_spc(pci_data) |>
  dplyr::filter(!is.na(age) & !is.na(inds_cat) & !is.na(hospital_volume_cat)) |>
  gtsummary::tbl_summary(
    include = c(age, sex_cat, inds_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca),
    by = "hospital_volume_cat",
    label = list(
      age ~ "Age",
      sex_cat ~ "Sex",
      inds_cat ~ "Indigenous Status",
      db ~ "Diabetic",
      pvd ~ "Peripheral Vascular Disease",
      bmi ~ "BMI",
      severe_obesity ~ "Severe Obesity (BMI ≥ 35kg/m²)",
      ppci ~ "Previous PCI",
      pcabg ~ "Previous CABG",
      shock ~ "Cardiogenic Shock",
      oca ~ "Out of Hospital Cardiac Arrest",
      los_cat ~ "Length of Stay"
    ),
    statistic = list(
      c(age, bmi) ~ "{mean} ({sd})",
      c(sex_cat, inds_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat) ~ "{n} ({p}%)"
    ),
    digits = list(
      c(age, bmi) ~ 1
    ),
    missing = "no"
  )
```

:::

## Patient Characteristics by Sex

```{r demographics by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(age) & !is.na(inds_cat) & !is.na(sex_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(age, inds_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca, acs_cat),
      by = "sex_cat",
      label = list(
        age ~ "Age",
        inds_cat ~ "Indigenous Status",
        db ~ "Diabetic",
        pvd ~ "Peripheral Vascular Disease",
        bmi ~ "BMI",
        severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
        ppci ~ "Previous PCI",
        pcabg ~ "Previous CABG",
        shock ~ "Cardiogenic Shock",
        oca ~ "Out of Hospital Cardiac Arrest",
        los_cat ~ "Length of Stay",
        acs_cat ~ "Clinical Presentation"
      ),
      statistic = list(
        c(age, bmi) ~ "{mean} ({sd})",
        c(inds_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat, acs_cat) ~ "{n} ({p}%)"
      ),
      digits = list(
        c(age, bmi) ~ 1
      ),
      missing = "no"
    )
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "sex_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(age, inds_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca, acs_cat),
        by = "comparison_group",
        label = list(
          age ~ "Age",
          inds_cat ~ "Indigenous Status",
          db ~ "Diabetic",
          pvd ~ "Peripheral Vascular Disease",
          bmi ~ "BMI",
          severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
          ppci ~ "Previous PCI",
          pcabg ~ "Previous CABG",
          shock ~ "Cardiogenic Shock",
          oca ~ "Out of Hospital Cardiac Arrest",
          los_cat ~ "Length of Stay",
          acs_cat ~ "Clinical Presentation"
        ),
        statistic = list(
          c(age, bmi) ~ "{mean} ({sd})",
          c(inds_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat, acs_cat) ~ "{n} ({p}%)"
        ),
        digits = list(
          c(age, bmi) ~ 1
        ),
        missing = "no"
      )
    )
}
```

## Aboriginal and Torres Strait Islander Patients by Clinical Presentation

```{r atsi by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(inds %in% c(1, 2, 3) & !is.na(age) & !is.na(acs_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(age, sex_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca),
      by = "acs_cat",
      label = list(
        age ~ "Age",
        sex_cat ~ "Sex",
        db ~ "Diabetic",
        pvd ~ "Peripheral Vascular Disease",
        bmi ~ "BMI",
        severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
        ppci ~ "Previous PCI",
        pcabg ~ "Previous CABG",
        shock ~ "Cardiogenic Shock",
        oca ~ "Out of Hospital Cardiac Arrest",
        los_cat ~ "Length of Stay"
      ),
      statistic = list(
        c(age, bmi) ~ "{mean} ({sd})",
        c(sex_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat) ~ "{n} ({p}%)"
      ),
      digits = list(
        c(age, bmi) ~ 1
      ),
      missing = "no"
    )
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(age, sex_cat, bmi, severe_obesity, los_cat, db, pvd, ppci, pcabg, shock, oca),
        by = "comparison_group",
        label = list(
          age ~ "Age",
          sex_cat ~ "Sex",
          db ~ "Diabetic",
          pvd ~ "Peripheral Vascular Disease",
          bmi ~ "BMI",
          severe_obesity ~ "Severe Obesity (BMI ≥ 35 kg/m²)",
          ppci ~ "Previous PCI",
          pcabg ~ "Previous CABG",
          shock ~ "Cardiogenic Shock",
          oca ~ "Out of Hospital Cardiac Arrest",
          los_cat ~ "Length of Stay"
        ),
        statistic = list(
          c(age, bmi) ~ "{mean} ({sd})",
          c(sex_cat, db, pvd, severe_obesity, ppci, pcabg, shock, oca, los_cat) ~ "{n} ({p}%)"
        ),
        digits = list(
          c(age, bmi) ~ 1
        ),
        missing = "no"
      )
    )
}
```

# Clinical Characteristics

## Number of PCI Procedures by Hospital

```{r cumulative sum cases, warning=FALSE, message=FALSE}
# Group data to get cumulative counts for each hid over time
group_data <- pci_data |>
  dplyr::group_by(hid, period_end) |>
  dplyr::summarise(.groups = "keep", count = dplyr::n()) |>
  dplyr::arrange(hid, period_end) |>
  dplyr::group_by(hid) |>
  dplyr::mutate(cumulative_count = cumsum(count))

# Cumulative sum of PCI cases over time
suppressWarnings(sum_plt <- ggplot2::ggplot(pci_data, ggplot2::aes(x = dop, colour = "Cumulative Total")) +
  ggplot2::stat_ecdf(ggplot2::aes(y = ggplot2::after_stat(y) * nrow(pci_data)), geom = "line", color = "black") +
  ggplot2::geom_col(data = group_data, mapping = ggplot2::aes(x = period_end, y = cumulative_count, fill = hid), position = "dodge", linewidth = 0) +
  ggplot2::labs(title = "Cumulative Total of PCI Cases Over Time",
       x = "Date of Procedure",
       y = "Cumulative Total of PCI Cases",
       fill = "Hospital",
       colour = "") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold")) +
  ggplot2::scale_y_continuous(breaks = scales::breaks_pretty(10)))
suppressWarnings(print_ggplot(sum_plt))
```

```{r demographics_intro}
demo_plt <- ggplot2::ggplot(pci_data, ggplot2::aes(x = reorder(hid, hid, FUN = length, decreasing = T))) +
  ggplot2::geom_bar(fill = "steelblue") +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::geom_text(ggplot2::aes(label = ggplot2::after_stat(count)), stat = "count", vjust = -0.5, size = 3) +
  ggplot2::labs(title = "Distribution of PCI Procedures by Hospital",
       x = "Hospital",
       y = "Count") +
  ggplot2::theme_minimal() +
  ggplot2::theme(plot.title = ggplot2::element_text(hjust = 0.5, size = 10, face = "bold"))
print_ggplot(demo_plt)
```



## Proportion of Patients with Previous PCI

```{r fpl_setup_ppci}
#| fig.cap="Funnel plot for the proportion of patients with a previous PCI"
fpl_data <- pci_funnel(
  data = pci_data,
  numerator_col = "ppci",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with a previous PCI",
    ylimit_label_size = 14,
    ylimit_sig_figs = 1,
    ylimit_u = 35
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

```{r spc_setup_ppci}
#| fig.cap="SPC chart for the proportion of patients with a previous PCI"
spc_data <- pci_spc(
  data = pci_data,
  numerator_col = "ppci",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with a previous PCI",
    ylimit_label_size = 14,
    ylimit_tick_rotation = 0,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "decrease")
)
spc_data
```

## Proportion of Patients with a previous CABG

```{r fpl_setup_pcabg}
#| fig.cap="Funnel plot for the proportion of patients with a previous CABG"
fpl_data <- pci_funnel(
  data = pci_data,
  numerator_col = "pcabg",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with a previous CABG",
    ylimit_label_size = 14,
    ylimit_sig_figs = 1,
    ylimit_u = 7
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

```{r spc_setup_pcabg}
#| fig.cap="SPC chart for the proportion of patients with a previous CABG"
spc_data <- pci_spc(
  data = pci_data,
  numerator_col = "pcabg",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with a previous CABG",
    ylimit_label_size = 14,
    ylimit_tick_rotation = 0,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "decrease")
)
spc_data
```

## Proportion of Patients with out of hospital cardiac arrest (OHCA)

```{r fpl_setup_pOHCA}
#| fig.cap="Funnel plot for the proportion of patients with an OHCA"
fpl_data <- pci_funnel(
  data = pci_data,
  numerator_col = "oca",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with OHCA",
    ylimit_label_size = 14,
    ylimit_sig_figs = 1,
    ylimit_u = 7
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
fpl_data
```

```{r spc_setup_pOHCA}
#| fig.cap="SPC chart for the proportion of patients with an OHCA"
spc_data <- pci_spc(
  data = pci_data,
  numerator_col = "oca",
  y_axis_settings = list(
    ylimit_label = "% PCI Patients with an OHCA",
    ylimit_label_size = 14,
    ylimit_tick_rotation = 0,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "decrease")
)
spc_data
```

# Procedural Characteristics

This section presents procedural characteristics stratified by key patient and hospital factors, following the NCR Annual Report structure.

## Procedural Characteristics by Clinical Presentation

```{r procedural by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
      by = "acs_cat",
      label = list(
        access_route ~ "Arterial Access Route",
        radial_access ~ "Radial Access",
        des_used ~ "Drug-Eluting Stent Used",
        any_isr ~ "In-Stent Restenosis",
        multi_vessel ~ "Multi-Vessel Disease",
        num_lesions ~ "Number of Lesions"
      ),
      type = list(
        num_lesions ~ "continuous"
      ),
      statistic = list(
        c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
        c(num_lesions) ~ "{mean} ({sd})"
      ),
      digits = list(
        c(num_lesions) ~ 1
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
        by = "comparison_group",
        label = list(
          access_route ~ "Arterial Access Route",
          radial_access ~ "Radial Access",
          des_used ~ "Drug-Eluting Stent Used",
          any_isr ~ "In-Stent Restenosis",
          multi_vessel ~ "Multi-Vessel Disease",
          num_lesions ~ "Number of Lesions"
        ),
        type = list(
          num_lesions ~ "continuous"
        ),
        statistic = list(
          c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
          c(num_lesions) ~ "{mean} ({sd})"
        ),
        digits = list(
          c(num_lesions) ~ 1
        ),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

## Procedural Characteristics by Hospital Volume

```{r procedural by volume, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(hospital_volume_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
      by = "hospital_volume_cat",
      label = list(
        access_route ~ "Arterial Access Route",
        radial_access ~ "Radial Access",
        des_used ~ "Drug-Eluting Stent Used",
        any_isr ~ "In-Stent Restenosis",
        multi_vessel ~ "Multi-Vessel Disease",
        num_lesions ~ "Number of Lesions"
      ),
      type = list(
        num_lesions ~ "continuous"
      ),
      statistic = list(
        c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
        c(num_lesions) ~ "{mean} ({sd})"
      ),
      digits = list(
        c(num_lesions) ~ 1
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "hospital_volume_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
        by = "comparison_group",
        label = list(
          access_route ~ "Arterial Access Route",
          radial_access ~ "Radial Access",
          des_used ~ "Drug-Eluting Stent Used",
          any_isr ~ "In-Stent Restenosis",
          multi_vessel ~ "Multi-Vessel Disease",
          num_lesions ~ "Number of Lesions"
        ),
        type = list(
          num_lesions ~ "continuous"
        ),
        statistic = list(
          c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
          c(num_lesions) ~ "{mean} ({sd})"
        ),
        digits = list(
          c(num_lesions) ~ 1
        ),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

## Procedural Characteristics by Sex

```{r procedural by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(sex_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
      by = "sex_cat",
      label = list(
        access_route ~ "Arterial Access Route",
        radial_access ~ "Radial Access",
        des_used ~ "Drug-Eluting Stent Used",
        any_isr ~ "In-Stent Restenosis",
        multi_vessel ~ "Multi-Vessel Disease",
        num_lesions ~ "Number of Lesions"
      ),
      type = list(
        num_lesions ~ "continuous"
      ),
      statistic = list(
        c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
        c(num_lesions) ~ "{mean} ({sd})"
      ),
      digits = list(
        c(num_lesions) ~ 1
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "sex_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
        by = "comparison_group",
        label = list(
          access_route ~ "Arterial Access Route",
          radial_access ~ "Radial Access",
          des_used ~ "Drug-Eluting Stent Used",
          any_isr ~ "In-Stent Restenosis",
          multi_vessel ~ "Multi-Vessel Disease",
          num_lesions ~ "Number of Lesions"
        ),
        type = list(
          num_lesions ~ "continuous"
        ),
        statistic = list(
          c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
          c(num_lesions) ~ "{mean} ({sd})"
        ),
        digits = list(
          c(num_lesions) ~ 1
        ),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

## Procedural Characteristics for Aboriginal and Torres Strait Islander Patients

```{r procedural atsi by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(inds %in% c(1, 2, 3), !is.na(acs_cat))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
      by = "acs_cat",
      label = list(
        access_route ~ "Arterial Access Route",
        radial_access ~ "Radial Access",
        des_used ~ "Drug-Eluting Stent Used",
        any_isr ~ "In-Stent Restenosis",
        multi_vessel ~ "Multi-Vessel Disease",
        num_lesions ~ "Number of Lesions"
      ),
      type = list(
        num_lesions ~ "continuous"
      ),
      statistic = list(
        c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
        c(num_lesions) ~ "{mean} ({sd})"
      ),
      digits = list(
        c(num_lesions) ~ 1
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(access_route, radial_access, des_used, any_isr, multi_vessel, num_lesions),
        by = "comparison_group",
        label = list(
          access_route ~ "Arterial Access Route",
          radial_access ~ "Radial Access",
          des_used ~ "Drug-Eluting Stent Used",
          any_isr ~ "In-Stent Restenosis",
          multi_vessel ~ "Multi-Vessel Disease",
          num_lesions ~ "Number of Lesions"
        ),
        type = list(
          num_lesions ~ "continuous"
        ),
        statistic = list(
          c(access_route, radial_access, des_used, any_isr, multi_vessel) ~ "{n} ({p}%)",
          c(num_lesions) ~ "{mean} ({sd})"
        ),
        digits = list(
          c(num_lesions) ~ 1
        ),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

# Temporal Trends

This section presents trends over time for key procedural characteristics and quality indicators.

## Registry Growth Over Time

```{r registry growth, message=FALSE, warning=FALSE, fig.height=5, fig.width=10}
# Monthly procedure counts
monthly_counts <- pci_data |>
  dplyr::group_by(period_end) |>
  dplyr::summarise(
    procedures = dplyr::n(),
    .groups = "drop"
  ) |>
  dplyr::arrange(period_end) |>
  dplyr::mutate(cumulative = cumsum(procedures))

# Create dual-axis plot for monthly and cumulative counts
suppressWarnings(
  growth_plt <- ggplot2::ggplot(monthly_counts, ggplot2::aes(x = period_end)) +
    ggplot2::geom_col(ggplot2::aes(y = procedures, fill = "Monthly Procedures"), alpha = 0.7) +
    ggplot2::geom_line(ggplot2::aes(y = cumulative / max(cumulative) * max(procedures), colour = "Cumulative Total"), linewidth = 1.2) +
    ggplot2::scale_y_continuous(
      name = "Monthly Procedures",
      sec.axis = ggplot2::sec_axis(~ . * max(monthly_counts$cumulative) / max(monthly_counts$procedures), name = "Cumulative Total")
    ) +
    ggplot2::scale_fill_manual(values = c("Monthly Procedures" = "steelblue")) +
    ggplot2::scale_colour_manual(values = c("Cumulative Total" = "darkred")) +
    ggplot2::labs(
      title = "PCI Registry Growth Over Time",
      x = "Month",
      fill = "",
      colour = ""
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, size = 12, face = "bold"),
      legend.position = "bottom"
    )
)
print_ggplot(growth_plt)
```

## Radial Access Rate

### Funnel Plot - Hospital Comparison

```{r radial access funnel, message=FALSE, warning=FALSE}
# Funnel plot for radial access rate by hospital/clinician
radial_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(!is.na(pel)),
  numerator_col = "radial_access",
  y_axis_settings = list(
    ylimit_label = "% Radial Access",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI Procedures",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
radial_fpl
```

### SPC Chart - Trend Over Time

```{r radial access spc, message=FALSE, warning=FALSE}
# SPC chart for radial access rate
radial_spc <- pci_spc(
  data = pci_data |> dplyr::filter(!is.na(pel)),
  numerator_col = "radial_access",
  y_axis_settings = list(
    ylimit_label = "% Radial Access",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
radial_spc
```

## Radial Access Rate by Sex - SPC Charts

### Female Patients

```{r radial female spc, message=FALSE, warning=FALSE}
# SPC chart for radial access rate - Female
radial_female_spc <- pci_spc(
  data = pci_data |> dplyr::filter(!is.na(pel) & sex == 2),
  numerator_col = "radial_access",
  y_axis_settings = list(
    ylimit_label = "% Radial Access (Female)",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
radial_female_spc
```

### Male Patients

```{r radial male spc, message=FALSE, warning=FALSE}
# SPC chart for radial access rate - Male
radial_male_spc <- pci_spc(
  data = pci_data |> dplyr::filter(!is.na(pel) & sex == 1),
  numerator_col = "radial_access",
  y_axis_settings = list(
    ylimit_label = "% Radial Access (Male)",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
radial_male_spc
```

## Drug-Eluting Stent Usage

### Funnel Plot - Hospital Comparison

```{r des funnel, message=FALSE, warning=FALSE}
# Funnel plot for DES usage rate by hospital/clinician
des_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(!is.na(des_used)),
  numerator_col = "des_used",
  y_axis_settings = list(
    ylimit_label = "% Drug-Eluting Stent Usage",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI Procedures",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
des_fpl
```

### SPC Chart - Trend Over Time

```{r des spc, message=FALSE, warning=FALSE}
# SPC chart for DES usage rate
des_spc <- pci_spc(
  data = pci_data |> dplyr::filter(!is.na(des_used)),
  numerator_col = "des_used",
  y_axis_settings = list(
    ylimit_label = "% Drug-Eluting Stent Usage",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
des_spc
```

## Door-to-Device Time ≤60 Minutes

```{r d2d indicators setup, message=FALSE, warning=FALSE}
# Create indicators for achieving targets (moved outside chunks for reuse)
pci_data <- pci_data |>
  dplyr::mutate(
    d2d_under_60 = dplyr::if_else(NCR2_den == 1 & !is.na(dbdt) & dbdt <= 60, 1, 0, missing = 0),
    d2d_under_90 = dplyr::if_else(NCR2_den == 1 & !is.na(dbdt) & dbdt <= 90, 1, 0, missing = 0)
  )
```

### Funnel Plot - Hospital Comparison

```{r d2d 60 funnel, message=FALSE, warning=FALSE}
# Funnel plot for door-to-device ≤60 min by hospital/clinician
d2d_60_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(NCR2_den == 1 & !is.na(dbdt)),
  numerator_col = "d2d_under_60",
  y_axis_settings = list(
    ylimit_label = "% Achieving Door-to-Device ≤60 min",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of Primary PCI Procedures",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
d2d_60_fpl
```

### SPC Chart - Trend Over Time

```{r d2d 60 spc, message=FALSE, warning=FALSE}
# SPC chart for door-to-device ≤60 min achievement
d2d_60_spc <- pci_spc(
  data = pci_data |> dplyr::filter(NCR2_den == 1 & !is.na(dbdt)),
  numerator_col = "d2d_under_60",
  y_axis_settings = list(
    ylimit_label = "% Achieving Door-to-Device ≤60 min",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
d2d_60_spc
```

## Door-to-Device Time ≤90 Minutes

### Funnel Plot - Hospital Comparison

```{r d2d 90 funnel, message=FALSE, warning=FALSE}
# Funnel plot for door-to-device ≤90 min by hospital/clinician
d2d_90_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(NCR2_den == 1 & !is.na(dbdt)),
  numerator_col = "d2d_under_90",
  y_axis_settings = list(
    ylimit_label = "% Achieving Door-to-Device ≤90 min",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of Primary PCI Procedures",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
d2d_90_fpl
```

### SPC Chart - Trend Over Time

```{r d2d 90 spc, message=FALSE, warning=FALSE}
# SPC chart for door-to-device ≤90 min achievement
d2d_90_spc <- pci_spc(
  data = pci_data |> dplyr::filter(NCR2_den == 1 & !is.na(dbdt)),
  numerator_col = "d2d_under_90",
  y_axis_settings = list(
    ylimit_label = "% Achieving Door-to-Device ≤90 min",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
d2d_90_spc
```

## DAPT at Discharge

### Funnel Plot - Hospital Comparison

```{r dapt funnel, message=FALSE, warning=FALSE}
# Funnel plot for DAPT at discharge by hospital/clinician
dapt_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(NCR11_den == 1),
  numerator_col = "NCR11_num",
  y_axis_settings = list(
    ylimit_label = "% DAPT at Discharge",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of Eligible Patients",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
dapt_fpl
```

### SPC Chart - Trend Over Time

```{r dapt spc, message=FALSE, warning=FALSE}
# SPC chart for DAPT at discharge
dapt_spc <- pci_spc(
  data = pci_data |> dplyr::filter(NCR11_den == 1),
  numerator_col = "NCR11_num",
  y_axis_settings = list(
    ylimit_label = "% DAPT at Discharge",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
dapt_spc
```

## Lipid-Lowering Therapy at Discharge

### Funnel Plot - Hospital Comparison

```{r llt funnel, message=FALSE, warning=FALSE}
# Funnel plot for lipid-lowering therapy at discharge by hospital/clinician
llt_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(NCR9_den == 1),
  numerator_col = "NCR9_num",
  y_axis_settings = list(
    ylimit_label = "% Lipid-Lowering Therapy at Discharge",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of Eligible Patients",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
llt_fpl
```

### SPC Chart - Trend Over Time

```{r llt spc, message=FALSE, warning=FALSE}
# SPC chart for lipid-lowering therapy at discharge
llt_spc <- pci_spc(
  data = pci_data |> dplyr::filter(NCR9_den == 1),
  numerator_col = "NCR9_num",
  y_axis_settings = list(
    ylimit_label = "% Lipid-Lowering Therapy at Discharge",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
llt_spc
```

## Cardiac Rehabilitation Referral

### Funnel Plot - Hospital Comparison

```{r rehab funnel, message=FALSE, warning=FALSE}
# Funnel plot for cardiac rehabilitation referral by hospital/clinician
rehab_fpl <- pci_funnel(
  data = pci_data |> dplyr::filter(NCR10_den == 1),
  numerator_col = "NCR10_num",
  y_axis_settings = list(
    ylimit_label = "% Cardiac Rehabilitation Referral",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0,
    ylimit_u = 100
  ),
  x_axis_settings = list(
    xlimit_label = "Number of Eligible Patients",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "increase",
    three_sigma = TRUE
  )
)
rehab_fpl
```

### SPC Chart - Trend Over Time

```{r rehab spc, message=FALSE, warning=FALSE}
# SPC chart for cardiac rehabilitation referral
rehab_spc <- pci_spc(
  data = pci_data |> dplyr::filter(NCR10_den == 1),
  numerator_col = "NCR10_num",
  y_axis_settings = list(
    ylimit_label = "% Cardiac Rehabilitation Referral",
    ylimit_label_size = 14,
    ylimit_sig_figs = 0
  ),
  outlier_settings = list(improvement_direction = "increase"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
rehab_spc
```

## In-Hospital Mortality

### Funnel Plot - Hospital Comparison

```{r mortality funnel, message=FALSE, warning=FALSE}
# Funnel plot for in-hospital mortality by hospital/clinician
mortality_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR5_num",
  y_axis_settings = list(
    ylimit_label = "% In-Hospital Mortality",
    ylimit_label_size = 14,
    ylimit_sig_figs = 1,
    ylimit_u = 10
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI Procedures",
    xlimit_label_size = 14
  ),
  outlier_settings = list(
    improvement_direction = "decrease",
    three_sigma = TRUE
  )
)
mortality_fpl
```

### SPC Chart - Trend Over Time

```{r mortality spc, message=FALSE, warning=FALSE}
# SPC chart for in-hospital mortality
mortality_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR5_num",
  y_axis_settings = list(
    ylimit_label = "% In-Hospital Mortality",
    ylimit_label_size = 14,
    ylimit_sig_figs = 1
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
mortality_spc
```

## Hospital Performance Comparison

```{r hospital performance, message=FALSE, warning=FALSE, fig.height=6, fig.width=10}
# Hospital-level performance metrics
hospital_performance <- pci_data |>
  dplyr::group_by(hid) |>
  dplyr::summarise(
    procedures = dplyr::n(),
    radial_pct = sum(radial_access, na.rm = TRUE) / dplyr::n() * 100,
    des_pct = sum(des_used, na.rm = TRUE) / sum(!is.na(des_used)) * 100,
    dapt_pct = sum(NCR11_num, na.rm = TRUE) / sum(stringr::str_detect(dis, "[12345]"), na.rm = TRUE) * 100,
    llt_pct = sum(NCR9_num, na.rm = TRUE) / sum(stringr::str_detect(dis, "[12345]"), na.rm = TRUE) * 100,
    mortality_pct = sum(NCR5_num, na.rm = TRUE) / dplyr::n() * 100,
    .groups = "drop"
  )

# Reshape for plotting
hospital_perf_long <- hospital_performance |>
  tidyr::pivot_longer(
    cols = c(radial_pct, des_pct, dapt_pct, llt_pct),
    names_to = "metric",
    values_to = "percentage"
  ) |>
  dplyr::mutate(
    metric = dplyr::case_when(
      metric == "radial_pct" ~ "Radial Access",
      metric == "des_pct" ~ "DES Usage",
      metric == "dapt_pct" ~ "DAPT at Discharge",
      metric == "llt_pct" ~ "Lipid-Lowering Therapy"
    ),
    metric = factor(metric, levels = c("Radial Access", "DES Usage", "DAPT at Discharge", "Lipid-Lowering Therapy"))
  )

suppressWarnings(
  hosp_perf_plt <- ggplot2::ggplot(hospital_perf_long, ggplot2::aes(x = hid, y = percentage, fill = metric)) +
    ggplot2::geom_col(position = "dodge") +
    ggplot2::geom_hline(yintercept = 80, linetype = "dashed", colour = "black", linewidth = 0.5) +
    ggplot2::labs(
      title = "Hospital Performance on Key Quality Metrics",
      x = "Hospital",
      y = "Achievement Rate (%)",
      fill = "Metric"
    ) +
    ggplot2::scale_y_continuous(limits = c(0, 100)) +
    ggplot2::scale_fill_brewer(palette = "Set2") +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, size = 12, face = "bold"),
      legend.position = "bottom",
      axis.text.x = ggplot2::element_text(angle = 45, hjust = 1)
    )
)
print_ggplot(hosp_perf_plt)
```

## Procedure Volume by Hospital Over Time

```{r volume by hospital trend, message=FALSE, warning=FALSE, fig.height=5, fig.width=10}
# Monthly volume by hospital
volume_trend <- pci_data |>
  dplyr::group_by(period_end, hid) |>
  dplyr::summarise(
    procedures = dplyr::n(),
    .groups = "drop"
  )

suppressWarnings(
  volume_plt <- ggplot2::ggplot(volume_trend, ggplot2::aes(x = period_end, y = procedures, fill = hid)) +
    ggplot2::geom_area(position = "stack", alpha = 0.8) +
    ggplot2::labs(
      title = "Monthly PCI Volume by Hospital",
      x = "Month",
      y = "Number of Procedures",
      fill = "Hospital"
    ) +
    ggplot2::theme_minimal() +
    ggplot2::theme(
      plot.title = ggplot2::element_text(hjust = 0.5, size = 12, face = "bold"),
      legend.position = "bottom"
    )
)
print_ggplot(volume_plt)
```

# STEMI Analysis

This section provides detailed analysis of STEMI cases, focusing on primary PCI procedures and reperfusion timing - key quality metrics for acute myocardial infarction care.

## Primary PCI Rates

Primary PCI is defined as PCI performed for STEMI patients within 12 hours of symptom onset, without prior lysis, presenting directly to the PCI center (not via inter-hospital transfer).

```{r primary pci summary}
# Calculate primary PCI rates
stemi_data <- filter_for_spc(pci_data) |> dplyr::filter(acs_cat == "STEMI")
primary_pci_summary <- stemi_data |>
  dplyr::summarise(
    total_stemi = dplyr::n(),
    primary_pci = sum(primary_pci, na.rm = TRUE),
    primary_pci_rate = round(sum(primary_pci, na.rm = TRUE) / dplyr::n() * 100, 1)
  )
```

There were a total of `r primary_pci_summary$total_stemi` STEMI cases, with `r primary_pci_summary$primary_pci` undergoing primary PCI, resulting in a primary PCI rate of `r primary_pci_summary$primary_pci_rate`%.

### Primary PCI Rates by Hospital Characteristics

```{r primary pci by characteristics, message=FALSE, warning=FALSE}
stemi_table_data <- get_table_data(pci_data) |>
  dplyr::filter(acs_cat == "STEMI" & !is.na(hospital_volume_cat))

if (report_context == "statewide") {
  stemi_table_data |>
    gtsummary::tbl_summary(
      include = c(primary_pci),
      by = "hospital_volume_cat",
      label = list(primary_pci ~ "Primary PCI"),
      type = list(primary_pci ~ "dichotomous"),
      value = list(primary_pci ~ 1),
      statistic = list(primary_pci ~ "{n} ({p}%)"),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  stemi_table_data |>
    gtsummary::tbl_strata(
      strata = "hospital_volume_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(primary_pci),
        by = "comparison_group",
        label = list(primary_pci ~ "Primary PCI"),
        type = list(primary_pci ~ "dichotomous"),
        value = list(primary_pci ~ 1),
        statistic = list(primary_pci ~ "{n} ({p}%)"),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

## Door-to-Device Time Analysis

Door-to-device time is a critical quality metric for primary PCI. The national target is ≤60 minutes, with ≤90 minutes as an acceptable secondary target.

```{r door to device summary}
# Filter to primary PCI cases with valid door-to-device times
d2d_data <- filter_for_spc(pci_data) |>
  dplyr::filter(NCR2_den == 1 & !is.na(dbdt) & dbdt > 0)

d2d_summary <- d2d_data |>
  dplyr::summarise(
    n = dplyr::n(),
    median_time = round(median(dbdt, na.rm = TRUE), 0),
    iqr_lower = round(quantile(dbdt, 0.25, na.rm = TRUE), 0),
    iqr_upper = round(quantile(dbdt, 0.75, na.rm = TRUE), 0),
    pct_under_60 = round(mean(dbdt <= 60, na.rm = TRUE) * 100, 1),
    pct_under_90 = round(mean(dbdt <= 90, na.rm = TRUE) * 100, 1)
  )
```

Of the `r d2d_summary$n` eligible primary PCI cases, the median door-to-device time was `r d2d_summary$median_time` minutes (IQR: `r d2d_summary$iqr_lower` - `r d2d_summary$iqr_upper` minutes).

`r d2d_summary$pct_under_60`% of cases achieved the target door-to-device time of ≤60 minutes, while `r d2d_summary$pct_under_90`% achieved the acceptable threshold of ≤90 minutes.

### Door-to-Device Time by Hospital

```{r door to device by hospital, message=FALSE, warning=FALSE}
d2d_by_hospital <- d2d_data |>
  dplyr::group_by(hid, hname) |>
  dplyr::summarise(
    n = dplyr::n(),
    median_time = round(median(dbdt, na.rm = TRUE), 0),
    iqr_lower = round(quantile(dbdt, 0.25, na.rm = TRUE), 0),
    iqr_upper = round(quantile(dbdt, 0.75, na.rm = TRUE), 0),
    pct_under_60 = round(mean(dbdt <= 60, na.rm = TRUE) * 100, 1),
    pct_under_90 = round(mean(dbdt <= 90, na.rm = TRUE) * 100, 1),
    .groups = "drop"
  )

d2d_table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR2_den == 1 & !is.na(dbdt) & dbdt > 0)

if (report_context == "statewide") {
  d2d_table_data |>
    dplyr::filter(!is.na(hname) & !is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_summary(
      include = c(dbdt, dbdt_under_60, dbdt_under_90),
      by = "hname",
      label = list(
        dbdt ~ "Door-to-Device Time (min)",
        dbdt_under_60 ~ "Achieved ≤60 minutes",
        dbdt_under_90 ~ "Achieved ≤90 minutes"
      ),
      type = list(
        dbdt ~ "continuous",
        dbdt_under_60 ~ "dichotomous",
        dbdt_under_90 ~ "dichotomous"
      ),
      value = list(
        dbdt_under_60 ~ TRUE,
        dbdt_under_90 ~ TRUE
      ),
      statistic = list(
        dbdt ~ "{median} ({p25}, {p75})",
        c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
      ),
      digits = list(dbdt ~ 0),
      missing = "no"
    )
} else {
  d2d_table_data |>
    dplyr::filter(!is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_summary(
      include = c(dbdt, dbdt_under_60, dbdt_under_90),
      by = "comparison_group",
      label = list(
        dbdt ~ "Door-to-Device Time (min)",
        dbdt_under_60 ~ "Achieved ≤60 minutes",
        dbdt_under_90 ~ "Achieved ≤90 minutes"
      ),
      type = list(
        dbdt ~ "continuous",
        dbdt_under_60 ~ "dichotomous",
        dbdt_under_90 ~ "dichotomous"
      ),
      value = list(
        dbdt_under_60 ~ TRUE,
        dbdt_under_90 ~ TRUE
      ),
      statistic = list(
        dbdt ~ "{median} ({p25}, {p75})",
        c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
      ),
      digits = list(dbdt ~ 0),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
}
```

### Door-to-Device Box Plot by Hospital

```{r door to device boxplot, fig.width=8, fig.height=5}
d2d_plot <- d2d_data |>
  dplyr::filter(dbdt <= 200) |>  # Exclude extreme outliers for visualization
  ggplot2::ggplot(ggplot2::aes(x = hname, y = as.numeric(dbdt), fill = hname)) +
  ggplot2::geom_boxplot(alpha = 0.7) +
  ggplot2::geom_hline(yintercept = 60, linetype = "dashed", color = "red", linewidth = 1) +
  ggplot2::geom_hline(yintercept = 90, linetype = "dashed", color = "orange", linewidth = 1) +
  ggplot2::annotate("text", x = 0.5, y = 65, label = "Target: ≤60 min", hjust = 0, color = "red") +
  ggplot2::annotate("text", x = 0.5, y = 95, label = "Acceptable: ≤90 min", hjust = 0, color = "orange") +
  ggplot2::labs(
    title = "Door-to-Device Time Distribution by Hospital",
    x = "Hospital",
    y = "Door-to-Device Time (minutes)"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = "none",
    plot.title = ggplot2::element_text(hjust = 0.5, face = "bold")
  )

print_ggplot(d2d_plot)
```

### Target Achievement by Hospital

```{r target achievement chart, fig.width=8, fig.height=5}
achievement_plot <- d2d_by_hospital |>
  tidyr::pivot_longer(cols = c(pct_under_60, pct_under_90),
                      names_to = "target",
                      values_to = "percentage") |>
  dplyr::mutate(
    target_label = dplyr::case_when(
      target == "pct_under_60" ~ "≤60 minutes",
      target == "pct_under_90" ~ "≤90 minutes"
    )
  ) |>
  ggplot2::ggplot(ggplot2::aes(x = hname, y = percentage, fill = target_label)) +
  ggplot2::geom_bar(stat = "identity", position = "dodge") +
  ggplot2::geom_text(ggplot2::aes(label = paste0(percentage, "%")),
                     position = ggplot2::position_dodge(width = 0.9),
                     vjust = -0.5, size = 3) +
  ggplot2::scale_fill_manual(values = c("≤60 minutes" = "#d62728", "≤90 minutes" = "#ff7f0e")) +
  ggplot2::labs(
    title = "Door-to-Device Target Achievement by Hospital",
    x = "Hospital",
    y = "Percentage Achieving Target (%)",
    fill = "Target"
  ) +
  ggplot2::theme_minimal() +
  ggplot2::theme(
    legend.position = "bottom",
    plot.title = ggplot2::element_text(hjust = 0.5, face = "bold")
  ) +
  ggplot2::ylim(0, 100)

print_ggplot(achievement_plot)
```

## Pre-Hospital Notification Impact

Pre-hospital notification allows the cardiac catheterization lab team to prepare in advance, potentially reducing door-to-device times.

```{r prehosp notification summary}
prehosp_data <- d2d_data |>
  dplyr::mutate(
    notification_status = dplyr::if_else(prehosp_notif == 1,
                                         "Pre-hospital Notification",
                                         "No Pre-hospital Notification")
  )

prehosp_table_data <- d2d_table_data |>
  dplyr::mutate(
    notification_status = dplyr::if_else(prehosp_notif == 1,
                                         "Pre-hospital Notification",
                                         "No Pre-hospital Notification")
  )

if (report_context == "statewide") {
  prehosp_table_data |>
    dplyr::filter(!is.na(notification_status) & !is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_summary(
      include = c(dbdt, dbdt_under_60, dbdt_under_90),
      by = "notification_status",
      label = list(
        dbdt ~ "Door-to-Device Time (min)",
        dbdt_under_60 ~ "Achieved ≤60 minutes",
        dbdt_under_90 ~ "Achieved ≤90 minutes"
      ),
      type = list(
        dbdt ~ "continuous",
        dbdt_under_60 ~ "dichotomous",
        dbdt_under_90 ~ "dichotomous"
      ),
      value = list(
        dbdt_under_60 ~ TRUE,
        dbdt_under_90 ~ TRUE
      ),
      statistic = list(
        dbdt ~ "{median} ({p25}, {p75})",
        c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
      ),
      digits = list(dbdt ~ 0),
      missing = "no"
    )
} else {
  prehosp_table_data |>
    dplyr::filter(!is.na(notification_status) & !is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_strata(
      strata = "notification_status",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(dbdt, dbdt_under_60, dbdt_under_90),
        by = "comparison_group",
        label = list(
          dbdt ~ "Door-to-Device Time (min)",
          dbdt_under_60 ~ "Achieved ≤60 minutes",
          dbdt_under_90 ~ "Achieved ≤90 minutes"
        ),
        type = list(
          dbdt ~ "continuous",
          dbdt_under_60 ~ "dichotomous",
          dbdt_under_90 ~ "dichotomous"
        ),
        value = list(
          dbdt_under_60 ~ TRUE,
          dbdt_under_90 ~ TRUE
        ),
        statistic = list(
          dbdt ~ "{median} ({p25}, {p75})",
          c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
        ),
        digits = list(dbdt ~ 0),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

### Pre-Hospital Notification Rates by Hospital

```{r prehosp notification rates, message=FALSE, warning=FALSE}
stemi_table_data <- get_table_data(pci_data) |>
  dplyr::filter(acs_cat == "STEMI")

if (report_context == "statewide") {
  stemi_table_data |>
    dplyr::filter(!is.na(hname)) |>
    gtsummary::tbl_summary(
      include = c(prehosp_notif),
      by = "hname",
      label = list(prehosp_notif ~ "Pre-hospital Notification"),
      type = list(prehosp_notif ~ "dichotomous"),
      value = list(prehosp_notif ~ 1),
      statistic = list(prehosp_notif ~ "{n} ({p}%)"),
      missing = "no"
    )
} else {
  stemi_table_data |>
    gtsummary::tbl_summary(
      include = c(prehosp_notif),
      by = "comparison_group",
      label = list(prehosp_notif ~ "Pre-hospital Notification"),
      type = list(prehosp_notif ~ "dichotomous"),
      value = list(prehosp_notif ~ 1),
      statistic = list(prehosp_notif ~ "{n} ({p}%)"),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
}
```

## Out-of-Hours Procedures

Procedures performed outside regular business hours (weekends or outside 8am-6pm) may face staffing or resource challenges.

```{r out of hours analysis, message=FALSE, warning=FALSE}
ooh_data <- d2d_data |>
  dplyr::mutate(
    hours_status = dplyr::if_else(out_of_hours == 1,
                                  "Out-of-Hours",
                                  "In-Hours")
  )

ooh_table_data <- d2d_table_data |>
  dplyr::mutate(
    hours_status = dplyr::if_else(out_of_hours == 1,
                                  "Out-of-Hours",
                                  "In-Hours")
  )

if (report_context == "statewide") {
  ooh_table_data |>
    dplyr::filter(!is.na(hours_status) & !is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_summary(
      include = c(dbdt, dbdt_under_60, dbdt_under_90),
      by = "hours_status",
      label = list(
        dbdt ~ "Door-to-Device Time (min)",
        dbdt_under_60 ~ "Achieved ≤60 minutes",
        dbdt_under_90 ~ "Achieved ≤90 minutes"
      ),
      type = list(
        dbdt ~ "continuous",
        dbdt_under_60 ~ "dichotomous",
        dbdt_under_90 ~ "dichotomous"
      ),
      value = list(
        dbdt_under_60 ~ TRUE,
        dbdt_under_90 ~ TRUE
      ),
      statistic = list(
        dbdt ~ "{median} ({p25}, {p75})",
        c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
      ),
      digits = list(dbdt ~ 0),
      missing = "no"
    )
} else {
  ooh_table_data |>
    dplyr::filter(!is.na(hours_status) & !is.na(dbdt)) |>
    dplyr::mutate(
      dbdt_under_60 = dbdt <= 60,
      dbdt_under_90 = dbdt <= 90
    ) |>
    gtsummary::tbl_strata(
      strata = "hours_status",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(dbdt, dbdt_under_60, dbdt_under_90),
        by = "comparison_group",
        label = list(
          dbdt ~ "Door-to-Device Time (min)",
          dbdt_under_60 ~ "Achieved ≤60 minutes",
          dbdt_under_90 ~ "Achieved ≤90 minutes"
        ),
        type = list(
          dbdt ~ "continuous",
          dbdt_under_60 ~ "dichotomous",
          dbdt_under_90 ~ "dichotomous"
        ),
        value = list(
          dbdt_under_60 ~ TRUE,
          dbdt_under_90 ~ TRUE
        ),
        statistic = list(
          dbdt ~ "{median} ({p25}, {p75})",
          c(dbdt_under_60, dbdt_under_90) ~ "{n} ({p}%)"
        ),
        digits = list(dbdt ~ 0),
        missing = "no"
      ) |>
        add_overall_if_statewide(report_context = report_context)
    )
}
```

# Secondary Prevention
+
This section presents discharge medication and cardiac rehabilitation rates, stratified by key patient and hospital characteristics. Secondary prevention measures are critical for reducing recurrent cardiac events.

## Discharge Medications by Clinical Presentation

```{r discharge meds by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR11_num, NCR9_num),
      by = "acs_cat",
      label = list(
        NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
        NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
      ),
      statistic = list(
        c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR11_num, NCR9_num),
        by = "comparison_group",
        label = list(
          NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
          NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
        ),
        statistic = list(
          c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Discharge Medications by Hospital Volume

```{r discharge meds by volume, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(hospital_volume_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR11_num, NCR9_num),
      by = "hospital_volume_cat",
      label = list(
        NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
        NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
      ),
      statistic = list(
        c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "hospital_volume_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR11_num, NCR9_num),
        by = "comparison_group",
        label = list(
          NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
          NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
        ),
        statistic = list(
          c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Discharge Medications by Sex

```{r discharge meds by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(sex_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR11_num, NCR9_num),
      by = "sex_cat",
      label = list(
        NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
        NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
      ),
      statistic = list(
        c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "sex_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR11_num, NCR9_num),
        by = "comparison_group",
        label = list(
          NCR11_num ~ "Discharged on DAPT (Aspirin + P2Y12 Inhibitor)",
          NCR9_num ~ "Discharged on Lipid-Lowering Therapy"
        ),
        statistic = list(
          c(NCR11_num, NCR9_num) ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Cardiac Rehabilitation Referral by Clinical Presentation

```{r cardiac rehab by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR10_num),
      by = "acs_cat",
      label = list(
        NCR10_num ~ "Referred to Cardiac Rehabilitation"
      ),
      statistic = list(
        NCR10_num ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR10_num),
        by = "comparison_group",
        label = list(
          NCR10_num ~ "Referred to Cardiac Rehabilitation"
        ),
        statistic = list(
          NCR10_num ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Cardiac Rehabilitation Referral by Hospital Volume

```{r cardiac rehab by volume, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(hospital_volume_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR10_num),
      by = "hospital_volume_cat",
      label = list(
        NCR10_num ~ "Referred to Cardiac Rehabilitation"
      ),
      statistic = list(
        NCR10_num ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "hospital_volume_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR10_num),
        by = "comparison_group",
        label = list(
          NCR10_num ~ "Referred to Cardiac Rehabilitation"
        ),
        statistic = list(
          NCR10_num ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Cardiac Rehabilitation Referral by Sex

```{r cardiac rehab by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(sex_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR10_num),
      by = "sex_cat",
      label = list(
        NCR10_num ~ "Referred to Cardiac Rehabilitation"
      ),
      statistic = list(
        NCR10_num ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "sex_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR10_num),
        by = "comparison_group",
        label = list(
          NCR10_num ~ "Referred to Cardiac Rehabilitation"
        ),
        statistic = list(
          NCR10_num ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

## Combined Secondary Prevention Measures

```{r combined secondary prevention, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat) & stringr::str_detect(dis, "[12345]"))

if (report_context == "statewide") {
  table_data |>
    gtsummary::tbl_summary(
      include = c(NCR11_num, NCR9_num, NCR10_num),
      by = "acs_cat",
      label = list(
        NCR11_num ~ "DAPT at Discharge",
        NCR9_num ~ "Lipid-Lowering Therapy at Discharge",
        NCR10_num ~ "Cardiac Rehabilitation Referral"
      ),
      statistic = list(
        c(NCR11_num, NCR9_num, NCR10_num) ~ "{n} ({p}%)"
      ),
      missing = "no"
    ) |>
    add_overall_if_statewide(report_context = report_context)
} else {
  table_data |>
    gtsummary::tbl_strata(
      strata = "acs_cat",
      .tbl_fun = ~ gtsummary::tbl_summary(
        .x,
        include = c(NCR11_num, NCR9_num, NCR10_num),
        by = "comparison_group",
        label = list(
          NCR11_num ~ "DAPT at Discharge",
          NCR9_num ~ "Lipid-Lowering Therapy at Discharge",
          NCR10_num ~ "Cardiac Rehabilitation Referral"
        ),
        statistic = list(
          c(NCR11_num, NCR9_num, NCR10_num) ~ "{n} ({p}%)"
        ),
        missing = "no"
      ) |>
          add_overall_if_statewide(report_context = report_context)
    )
}
```

The table above shows the combined achievement of key secondary prevention measures. Optimal secondary prevention includes all three components: DAPT, lipid-lowering therapy, and cardiac rehabilitation referral.

# Quality Indicators - Timing Metrics

# Time from diagnostic ECG to PCI mediated reperfusion

## SPC

```{r NCR1 SPC}
## Generate the SPC chart
NCR9_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR9_num",
  denominator_col = "NCR9_den",
  y_axis_settings = list(
    ylimit_u = 100,
    ylimit_l = 95,
    ylimit_label = "% patients discharged on Lipid Lowering Therapy after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "increase", three_sigma = TRUE)
)
## SPC

```{r NCR2 SPC}
## Generate the SPC chart
spc_filtered_data <- preaggregate_spc_median(
  filter_for_spc(dplyr::filter(pci_data, NCR2_den == 1)),
  value_col = "dbdt"
)
NCR2_spc <- controlcharts::spc(data = spc_filtered_data,
                   keys = period_end,
                   numerators = dbdt,
                   spc_settings = list(chart_type = "i"),
                   y_axis_settings = list(ylimit_label = "Median time from door to PCI (Minutes)",
                                          ylimit_sig_figs = 0,
                                          ylimit_label_size = 14),
                   outlier_settings = list(improvement_direction = "decrease",
                                           astronomical = TRUE,
                                           shift = TRUE,
                                           trend = TRUE,
                                           two_in_three = TRUE),
                   canvas_settings = list(upper_padding = 40),
                   nhs_icon_settings = list(show_variation_icons = TRUE),
                   date_settings = list(date_format_day = "(blank)",
                                    date_format_month = "Mon",
                                    date_format_year = "YY"))
NCR2_spc
```

# Peri-PCI stroke

## Funnel

```{r NCR3 Funnel}
## Generate the Funnel chart
NCR3_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "ihstr",
  denominator_col = "NCR3_den",
  y_axis_settings = list(
    ylimit_u = 2,
    ylimit_label = "% in-hospital stroke after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR3_fpl
```

The funnel plot above displays the information for **Peri-PCI Stroke** between **`r min(pci_data$period_start)`** and **`r max(pci_data$period_end)`**. The mean (or center line) value statewide is **`r round(NCR3_fpl$limits$target[1], 2)`**.

## SPC

```{r NCR3 SPC}
## Generate the SPC chart
NCR3_spc <- pci_spc(
  data = pci_data,
  numerator_col = "ihstr",
  denominator_col = "NCR3_den",
  y_axis_settings = list(
    ylimit_label = "% in-hospital stroke after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR3_spc
```

The Statistical Process Control (SPC) chart above displays the information for **Peri-PCI Stroke** between **`r min(pci_data$period_start)`** and **`r max(pci_data$period_end)`**. There was a total numerator of **`r format(sum(NCR3_fpl$limits$numerator), scientific = F, big.mark = ",")`**. There was a total denominator of **`r format(sum(NCR3_fpl$limits$denominator), scientific = F, big.mark = ",")`**. The mean (or center line) value statewide is **`r round(NCR3_fpl$limits$target[1], 2)`**.

# In-Hospital Major Bleeding

## Funnel

```{r NCR4 Funnel}
## Generate the Funnel chart
NCR4_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR4_num",
  denominator_col = "NCR4_den",
  y_axis_settings = list(
    ylimit_u = 2,
    ylimit_label = "% in-hospital major bleeding after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR4_fpl
```

## SPC

```{r NCR4 SPC}
## Generate the SPC chart
NCR4_spc <- pci_spc(
  data = dplyr::filter(pci_data, NCR4_den > 0),
  numerator_col = "NCR4_num",
  denominator_col = "NCR4_den",
  y_axis_settings = list(
    ylimit_label = "% in-hospital major bleeding after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR4_spc
```

# In-hospital mortality

## Funnel

```{r NCR5 Funnel}
## Generate the Funnel chart
NCR5_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR5_num",
  denominator_col = "NCR5_den",
  y_axis_settings = list(
    ylimit_u = 5,
    ylimit_label = "% in-hospital mortality after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR5_fpl
```

## SPC

```{r NCR5 SPC}
## Generate the SPC chart
NCR5_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR5_num",
  denominator_col = "NCR5_den",
  y_axis_settings = list(
    ylimit_label = "% in-hospital mortality after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR5_spc
```

# 30 day unplanned cardiac readmission rate after PCI

Cardiac readmission data is currently undergoing review. This data was not included in the 2024 NCR data submission.

## Funnel

```{r NCR6 Funnel}
## Generate the Funnel chart
NCR6_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR6_num",
  denominator_col = "NCR6_den",
  y_axis_settings = list(
    ylimit_u = 10,
    ylimit_label = "% 30 day unplanned cardiac readmissions after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR6_fpl
```

## SPC

```{r NCR6 SPC}
## Generate the SPC chart
NCR6_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR6_num",
  denominator_col = "NCR6_den",
  y_axis_settings = list(
    ylimit_label = "% 30 day unplanned cardiac readmissions after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR6_spc
```

# 30 day unplanned revascularisation rate after PCI

## Funnel

```{r NCR7 Funnel}
## Generate the Funnel chart
NCR7_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR7_num",
  denominator_col = "NCR7_den",
  y_axis_settings = list(
    ylimit_label = "% 30 day unplanned revascularisation after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR7_fpl
```

## SPC

```{r NCR7 SPC}
## Generate the SPC chart
NCR7_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR7_num",
  denominator_col = "NCR7_den",
  y_axis_settings = list(
    ylimit_label = "% 30 day unplanned revascularisation after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR7_spc
```

# 30 Day Mortality

## Funnel

```{r NCR8 Funnel}
## Generate the Funnel chart
NCR8_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR8_num",
  denominator_col = "NCR8_den",
  y_axis_settings = list(
    ylimit_u = 5,
    ylimit_label = "% 30 day mortality after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease", three_sigma = TRUE)
)
NCR8_fpl
```

## SPC

```{r NCR8 SPC}
## Generate the SPC chart
NCR8_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR8_num",
  denominator_col = "NCR8_den",
  y_axis_settings = list(
    ylimit_label = "% 30 day mortality after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "decrease"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR8_spc
```

# Patients Referred to Cardiac Rehabilitation

## Funnel

```{r NCR10 Funnel}
## Generate the Funnel chart
NCR10_spc <- pci_spc(
  data = pci_data,
  numerator_col = "NCR10_num",
  denominator_col = "NCR10_den",
  y_axis_settings = list(
    ylimit_label = "% patients referred to cardiac rehab after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "increase"),
  canvas_settings = list(upper_padding = 40),
  date_settings = list(
    date_format_day = "(blank)",
    date_format_month = "Mon",
    date_format_year = "YY"
  )
)
NCR10_spc
```

## SPC

```{r NCR10 SPC}
## Generate the SPC chart
NCR11_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR11_num",
  denominator_col = "NCR11_den",
  y_axis_settings = list(
    ylimit_u = 100,
    ylimit_l = 95,
    ylimit_label = "% patients discharged on Dual Antiplatelet Therapy after PCI",
    ylimit_sig_figs = 0,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "increase", three_sigma = TRUE)
)
```

# Patients Discharged on Lipid-Lowering Therapy

## Funnel

```{r NCR9 Funnel}
## Generate the Funnel chart
NCR9_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR9_num",
  denominator_col = "NCR9_den",
  y_axis_settings = list(
    ylimit_u = 100,
    ylimit_l = 95,
    ylimit_label = "% patients discharged on Lipid Lowering Therapy after PCI",
    ylimit_sig_figs = 1,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "increase", three_sigma = TRUE)
)
NCR9_fpl
```

## SPC

There is an explained error in the discharge medication data for October 2021, this point can be ignored for analysis.

```{r NCR9 SPC}
## Generate the SPC chart
spc_filtered_data <- filter_for_spc(pci_data) |>
  dplyr::filter(
    !is.na(period_end),
    !is.na(NCR9_den),
    NCR9_den > 0,
    !is.na(NCR9_num),
    period_end != as.Date("2021-10-31")
  )

spc_filtered_data <- preaggregate_spc_counts(spc_filtered_data, numerator_col = "NCR9_num", denominator_col = "NCR9_den")

if (nrow(spc_filtered_data) < 2) {
  cat("Not enough eligible data to generate the SPC chart for lipid-lowering therapy at discharge.")
} else {
  NCR9_spc <- controlcharts::spc(data = spc_filtered_data,
                   keys = period_end,
                   numerators = NCR9_num,
                   denominators = NCR9_den,
                   spc_settings = list(chart_type = "p"),
                   y_axis_settings = list(ylimit_label = "% patients discharged on Lipid Lowering Therapy after PCI",
                                          ylimit_sig_figs = 1,
                                          ylimit_label_size = 14),
                   outlier_settings = list(improvement_direction = "increase",
                                           astronomical = TRUE,
                                           shift = TRUE,
                                           trend = TRUE,
                                           two_in_three = TRUE),
                   canvas_settings = list(upper_padding = 40),
                   nhs_icon_settings = list(show_variation_icons = TRUE),
                   date_settings = list(date_format_day = "(blank)",
                                    date_format_month = "Mon",
                                    date_format_year = "YY"))
  NCR9_spc
}
```

# Patients Discharged on Dual Antiplatelet Therapy

## Funnel

```{r NCR11 Funnel}
## Generate the Funnel chart
NCR11_fpl <- pci_funnel(
  data = pci_data,
  numerator_col = "NCR11_num",
  denominator_col = "NCR11_den",
  y_axis_settings = list(
    ylimit_u = 100,
    ylimit_l = 95,
    ylimit_label = "% patients discharged on Dual Antiplatelet Therapy after PCI",
    ylimit_sig_figs = 0,
    ylimit_label_size = 14
  ),
  x_axis_settings = list(
    xlimit_label = "Number of PCI's",
    xlimit_label_size = 14
  ),
  outlier_settings = list(improvement_direction = "increase", three_sigma = TRUE)
)
NCR11_fpl
```

## SPC

There is an explained error in the discharge medication data for October 2021, this point can be ignored for analysis.

```{r NCR11 SPC}
## Generate the SPC chart
spc_filtered_data <- filter_for_spc(pci_data) |>
  dplyr::filter(
    !is.na(period_end),
    !is.na(NCR11_den),
    NCR11_den > 0,
    !is.na(NCR11_num),
    period_end != as.Date("2021-10-31")
  )

spc_filtered_data <- preaggregate_spc_counts(spc_filtered_data, numerator_col = "NCR11_num", denominator_col = "NCR11_den")

if (nrow(spc_filtered_data) < 2) {
  cat("Not enough eligible data to generate the SPC chart for dual antiplatelet therapy at discharge.")
} else {
  NCR11_spc <- controlcharts::spc(data = spc_filtered_data,
                   keys = period_end,
                   numerators = NCR11_num,
                   denominators = NCR11_den,
                   spc_settings = list(chart_type = "p"),
                   y_axis_settings = list(ylimit_label = "% patients discharged on Dual Antiplatelet Therapy after PCI",
                                          ylimit_sig_figs = 0,
                                          ylimit_label_size = 14),
                   outlier_settings = list(improvement_direction = "increase",
                                           astronomical = TRUE,
                                           shift = TRUE,
                                           trend = TRUE,
                                           two_in_three = TRUE),
                   canvas_settings = list(upper_padding = 40),
                   nhs_icon_settings = list(show_variation_icons = TRUE),
                   date_settings = list(date_format_day = "(blank)",
                                    date_format_month = "Mon",
                                    date_format_year = "YY"))
  NCR11_spc
}
```

# Comprehensive Outcomes Analysis

This section provides stratified analysis of in-hospital outcomes including mortality, complications, and composite endpoints.

## In-Hospital Mortality by Patient Subgroups

```{r mortality by subgroups, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR5_den == 1) |>
  dplyr::mutate(
    age_group = dplyr::case_when(
      age < 50 ~ "< 50 years",
      age >= 50 & age < 60 ~ "50-59 years",
      age >= 60 & age < 70 ~ "60-69 years",
      age >= 70 & age < 80 ~ "70-79 years",
      age >= 80 ~ "≥ 80 years"
    ),
    age_group = factor(age_group, levels = c("< 50 years", "50-59 years", "60-69 years", "70-79 years", "≥ 80 years")),
    shock_ohca = dplyr::if_else(shock == 1 | oca == 1, "Shock/OHCA", "No Shock/OHCA")
  )

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "age_group",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Age Group"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

### By Clinical Presentation

```{r mortality by presentation, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR5_den == 1 & !is.na(acs_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "acs_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Clinical Presentation"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

### By Shock/OHCA Status

```{r mortality by shock, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR5_den == 1) |>
  dplyr::mutate(
    shock_ohca = dplyr::if_else(shock == 1 | oca == 1, "With Shock/OHCA", "Without Shock/OHCA")
  )

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "shock_ohca",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Shock/OHCA Status"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

## In-Hospital Mortality by Hospital Characteristics

```{r mortality by hospital volume, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR5_den == 1 & !is.na(hospital_volume_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "hospital_volume_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Hospital Volume"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

### By Sex

```{r mortality by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(NCR5_den == 1 & !is.na(sex_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "sex_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Sex"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

## Comprehensive In-Hospital Outcomes by Clinical Presentation

```{r comprehensive outcomes by acs, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "acs_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Clinical Presentation"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

The table above shows all major in-hospital outcomes stratified by clinical presentation. MACE (Major Adverse Cardiac Events) includes death, MI, or unplanned revascularisation. MACCE (Major Adverse Cardiac and Cerebrovascular Events) includes MACE plus stroke.

## Comprehensive Outcomes by Hospital Volume

```{r comprehensive outcomes by volume, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(hospital_volume_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "hospital_volume_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Hospital Volume"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

## Comprehensive Outcomes by Sex

```{r comprehensive outcomes by sex, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(sex_cat))

outcome_labels <- c(
  NCR5_num = "In-Hospital Mortality",
  ihmi = "In-Hospital MI",
  ihstr = "In-Hospital Stroke",
  NCR4_num = "Major Bleeding",
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "sex_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Sex"
) |>
  flextable::flextable() |>
  flextable::autofit()
```

## MACE and MACCE Rates by Clinical Characteristics

```{r mace macce summary, message=FALSE, warning=FALSE}
mace_summary <- filter_for_spc(pci_data) |>
  dplyr::summarise(
    total_cases = dplyr::n(),
    mace_cases = sum(MACE, na.rm = TRUE),
    mace_rate = round(sum(MACE, na.rm = TRUE) / dplyr::n() * 100, 1),
    macce_cases = sum(MACCE, na.rm = TRUE),
    macce_rate = round(sum(MACCE, na.rm = TRUE) / dplyr::n() * 100, 1)
  )
```

**Overall MACE Rate:** `r mace_summary$mace_rate`% (`r mace_summary$mace_cases` of `r mace_summary$total_cases` cases)

**Overall MACCE Rate:** `r mace_summary$macce_rate`% (`r mace_summary$macce_cases` of `r mace_summary$total_cases` cases)

### MACE Rates by Patient Characteristics

```{r mace by characteristics, message=FALSE, warning=FALSE}
table_data <- get_table_data(pci_data) |>
  dplyr::filter(!is.na(acs_cat))

outcome_labels <- c(
  MACE = "MACE",
  MACCE = "MACCE"
)
comparison_col <- if (report_context == "statewide") NULL else "comparison_group"

build_outcome_table(
  table_data,
  group_col = "acs_cat",
  outcomes = names(outcome_labels),
  outcome_labels = outcome_labels,
  comparison_col = comparison_col,
  group_label = "Clinical Presentation"
) |>
  flextable::flextable() |>
  flextable::autofit()
```
